<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G√©n√©rateur de Bordereau Quantitatif (BOQ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* ======================================================================
            STYLES POUR L'IMPRESSION DU BOQ
            ====================================================================== */
      @media print {
        * {
          font-size: 10pt !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        body {
          background-color: white !important;
          margin: 1.5cm !important;
        }
        /* Masquer les boutons et la modal */
        .print-button,
        .save-button,
        #custom-modal,
        .screen-only,
        #report-reference {
          display: none !important;
        }
        /* Afficher les logos et titres correctement pour l'impression */
        .header-logos {
          display: flex;
          border-bottom: 3px solid #0056b3 !important;
          margin-bottom: 1cm !important;
        }
        .boq-table {
          border-collapse: collapse !important;
          width: 100% !important;
          margin-top: 20px !important;
          table-layout: fixed; /* Fixer le layout pour l'impression */
        }
        .boq-table th,
        .boq-table td {
          border: 1px solid #333 !important;
          padding: 6px !important;
          color: black !important;
          font-weight: normal !important;
          text-align: left !important;
        }
        .boq-table th {
          background-color: #f3f4f6 !important;
          font-weight: bold !important;
        }
        /* Ajustement des colonnes pour l'impression */
        .boq-table th:nth-child(3),
        .boq-table td:nth-child(3) {
          /* Quantit√© */
          text-align: right !important;
          width: 15%; /* Allouer plus d'espace √† la d√©signation */
        }
        .boq-table th:nth-child(4),
        .boq-table td:nth-child(4) {
          /* Prix Unitaire */
          text-align: right !important;
          width: 15%;
        }
        .boq-table th:nth-child(5),
        .boq-table td:nth-child(5) {
          /* Total */
          text-align: right !important;
          width: 20%;
        }
        .boq-table th:nth-child(1),
        .boq-table td:nth-child(1) {
          /* D√©signation */
          width: 40%;
        }
        .boq-table th:nth-child(2),
        .boq-table td:nth-child(2) {
          /* Unit√© */
          width: 10%;
        }
        .total-row td {
          font-weight: bold !important;
          background-color: #e5e7eb !important;
        }
        /* Assurer que les inputs de quantit√© sont affich√©s en texte normal pour l'impression */
        .qty-input {
          border: none !important;
          background-color: transparent !important;
          color: #000 !important;
          font-weight: 400 !important;
          text-align: right !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        /* Cache les lignes du BOQ avec quantit√© 0 */
        .boq-table tr.print-hide {
          display: none;
        }
      }

      /* ======================================================================
            STYLES POUR L'√âCRAN (RESPONSIVE)
            ====================================================================== */
      .text-moov-blue {
        color: #0056b3;
      }
      .bg-moov-blue {
        background-color: #0056b3;
      }
      .hover-bg-moov-orange:hover {
        background-color: #e67e00;
      }
      .bg-moov-orange {
        background-color: #ff8c00;
      }

      .header-logos {
        border-bottom: 3px solid #0056b3;
        /* Flex-wrap sur mobile pour que le titre puisse passer √† la ligne */
        flex-wrap: wrap;
      }

      /* Ajustement de l'en-t√™te sur mobile */
      @media (max-width: 767px) {
        .header-logos {
          justify-content: center;
          gap: 1rem;
        }
        .header-logos img {
          height: 40px; /* Logos plus petits sur mobile */
        }
        #boq-title {
          font-size: 1.5rem; /* Titre plus petit sur mobile */
          width: 100%;
          text-align: center;
          margin-top: 0.5rem;
        }
        .info-box {
          margin-bottom: 1rem;
        }
        .info-box .grid {
          grid-template-columns: 1fr; /* D√©tails d'incident en colonne */
        }
        .screen-only button {
          width: 100% !important; /* Boutons prennent toute la largeur */
          margin-top: 0.5rem;
        }
        .screen-only {
          flex-direction: column;
        }
      }

      /* Conteneur de tableau d√©filant sur mobile */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .boq-table input {
        text-align: right;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        padding: 0.5rem;
        width: 100%;
      }
      .boq-table .unit-price {
        text-align: right;
      }
      .total-row {
        background-color: #e5e7eb;
        font-weight: bold;
      }

      /* Styles pour la modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 50;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 90%;
        text-align: center;
      }
    </style>
  </head>
  <body class="bg-blue-50 font-sans leading-normal tracking-normal">
    <div class="container mx-auto max-w-6xl p-4 md:p-8">
      <header
        class="header-logos flex justify-between items-center mb-8 bg-white p-4 rounded-lg shadow-md"
      >
        <img
          src="LOGO ITC.png"
          alt="Logo ITC Ivoire Techno Com"
          class="h-12 md:h-16"
        />

        <div class="text-center flex-grow">
          <h1
            class="text-3xl md:text-4xl font-bold text-moov-blue"
            id="boq-title"
          >
            Bordereau Quantitatif (BOQ)
          </h1>
        </div>

        <img src="logo MOOV.png" alt="Logo Moov Africa" class="h-12 md:h-16" />
      </header>

      <div
        class="info-box bg-white p-4 rounded-lg shadow-md mb-6 border-l-4 border-moov-orange"
      >
        <h4 class="text-lg font-bold text-gray-700 mb-2">
          D√©tails de l'Incident Source :
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
          <p>
            <strong>Liaison (Incident) :</strong>
            <span id="info-liaison" class="font-semibold text-moov-blue"
              >--</span
            >
          </p>
          <p>
            <strong>Num√©ro de Ticket :</strong>
            <span id="info-ticket" class="font-semibold text-moov-blue"
              >--</span
            >
          </p>
          <p>
            <strong>Zone de Maintenance :</strong>
            <span id="info-zone" class="font-semibold text-moov-blue">--</span>
          </p>
        </div>
      </div>
      <section class="bg-white p-6 rounded-lg shadow-xl">
        <h2
          class="text-2xl font-semibold mb-4 border-b pb-2 border-moov-blue text-gray-800"
        >
          Quantit√©s de Mat√©riaux et Services Demand√©s
        </h2>

        <div class="table-container">
          <table
            id="boq-table"
            class="boq-table min-w-full divide-y divide-gray-200"
          >
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-6/12 min-w-[300px]"
                >
                  D√©signation
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12 min-w-[50px]"
                >
                  Unit√©
                </th>
                <th
                  class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12 min-w-[100px]"
                >
                  Quantit√©
                </th>
                <th
                  class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12 min-w-[100px]"
                >
                  Prix Unitaire (FCFA)
                </th>
                <th
                  class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12 min-w-[100px]"
                >
                  Total (FCFA)
                </th>
              </tr>
            </thead>
            <tbody
              id="boq-body"
              class="bg-white divide-y divide-gray-200"
            ></tbody>
            <tfoot>
              <tr class="total-row">
                <td
                  colspan="4"
                  class="px-3 py-2 text-right text-sm font-bold text-gray-800"
                >
                  TOTAL G√âN√âRAL H.T.
                </td>
                <td
                  id="grand-total"
                  class="px-3 py-2 text-right text-sm font-bold text-gray-800 bg-gray-300"
                >
                  0 FCFA
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-8 flex justify-center space-x-4 screen-only">
          <button
            onclick="saveBOQData(); showBOQAlert('Sauvegarde', 'Les donn√©es du BOQ ont √©t√© sauvegard√©es localement. Vous pouvez imprimer le bordereau.');"
            class="save-button bg-moov-blue hover-bg-moov-orange text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out w-full md:w-1/3"
          >
            üíæ Sauvegarder le BOQ
          </button>
          <button
            onclick="prepareForPrint();"
            class="print-button bg-moov-orange hover-bg-moov-orange text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out w-full md:w-1/3"
          >
            üñ®Ô∏è Imprimer le BOQ
          </button>
        </div>
      </section>
    </div>

    <div id="custom-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h4 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h4>
        <p id="modal-message" class="mb-6 text-gray-600"></p>
        <div id="modal-actions" class="flex justify-center space-x-4"></div>
      </div>
    </div>

    <script>
      const BOQ_STORAGE_KEY = "boqData";
      const REPORT_STORAGE_KEY = "incidentReportData";
      let PROFORMA_REFERENCE_ID =
        localStorage.getItem("proformaReferenceId") || "N/A"; // Conserver la r√©f√©rence pour la logique de stockage

      // Donn√©es compl√®tes extraites du fichier "UE TRAVAUX.csv"
      // Les IDs sont bas√©s sur la d√©signation pour assurer une cl√© unique
      const BOQ_STATIC_DATA = {
        FOURNITURE: {
          title: "I. FOURNITURE DU MATERIELS",
          subsections: {
            "Cables optiques": [
              {
                designation:
                  "Fibre optique (Single mode, 96F G.652d, 8 ou 16 Tubes, Tirage en conduite, micro-module)",
                unit: "u",
                unitPrice: 1725,
              },
              {
                designation:
                  "Fibre optique (Single mode, 48F G.652d, 4 ou 8 Tubes, Tirage en conduite, micro-module)",
                unit: "u",
                unitPrice: 1235,
              },
              {
                designation:
                  "Fibre optique (Single mode, 24F G.652d, 2 ou 4 Tubes, Tirage en conduite, micro-module)",
                unit: "u",
                unitPrice: 855,
              },
              {
                designation:
                  "Fibre optique (Single mode, 12F G.652d, 2 Tubes, Tirage en conduite, micro-module)",
                unit: "u",
                unitPrice: 610,
              },
              {
                designation:
                  "Fibre optique (Single mode, 6F G.652d, 2 Tubes, Tirage en conduite, micro-module)",
                unit: "u",
                unitPrice: 490,
              },
              {
                designation:
                  "Fibre optique (Single mode, 96F G.652d, 8 ou 16 Tubes, Protection m√©tallique, micro-module)",
                unit: "u",
                unitPrice: 2020,
              },
              {
                designation:
                  "Fibre optique (Single mode, 48F G.652d, 4 ou 8 Tubes, Protection m√©tallique, micro-module)",
                unit: "u",
                unitPrice: 1620,
              },
              {
                designation:
                  "Fibre optique (Single mode, 24F G.652d, 2 ou 4 Tubes, Protection m√©tallique, micro-module)",
                unit: "u",
                unitPrice: 1210,
              },
              {
                designation:
                  "Fibre optique (Single mode, 6F G.652d, 2 Tubes, Protection m√©tallique, micro-module)",
                unit: "u",
                unitPrice: 1025,
              },
            ],
            "Accessoires de tirage, fixation et d√©pose": [
              {
                designation:
                  "Petit-Jeans (ff) et Accessoires de fixation - Fourniture",
                unit: "ff",
                unitPrice: 2000,
              },
              {
                designation:
                  "Manchon droit 12 √† 96F (type ROUGE ou √©quivalent) - Fourniture",
                unit: "u",
                unitPrice: 20000,
              },
              {
                designation:
                  "Manchon droit 144 √† 288F (type NOIR ou √©quivalent) - Fourniture",
                unit: "u",
                unitPrice: 25000,
              },
              {
                designation:
                  "Fourniture Petit Mat√©riel Raccordement (Sleeve, Alcool, Papier, R√®gle, Coup√© Tube, D√©nudeur, M√®tre)",
                unit: "ff",
                unitPrice: 2000,
              },
              {
                designation: "Plantation d'un poteau simple 9m",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "Plantation d'un poteau simple 12m",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "Plantation d'un poteau mois√© 9m",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "D√©pose de petit-Jeans et Accessoires",
                unit: "u",
                unitPrice: 2500,
              },
              {
                designation: "D√©pose de Rack y compris ODF",
                unit: "u",
                unitPrice: 9500,
              },
              { designation: "D√©pose de ODF", unit: "u", unitPrice: 3041 },
              {
                designation: "D√©pose de RACK ODF",
                unit: "u",
                unitPrice: 10036,
              },
              {
                designation: "D√©pose ou destruction de chambre",
                unit: "u",
                unitPrice: 14500,
              },
              {
                designation: "D√©pose de c√¢ble souterain (24/48/96 paires)",
                unit: "ml",
                unitPrice: 110,
              },
              {
                designation:
                  "D√©pose de mat√©riel tout type (Jarreti√®res, Machons, c√¢ble optiques dans les salles techniques)",
                unit: "ff",
                unitPrice: 2000,
              },
            ],
          },
        },
        PRESTATION: {
          title: "II. PRESTATION DE SERVICES (III- SERVICES FTTH)",
          subsections: {
            "Pose, raccordement et installation": [
              {
                designation: "Pose et Raccordement splitter",
                unit: "u",
                unitPrice: 9800,
              },
              {
                designation: "Pose Raccordement splitter PCO",
                unit: "u",
                unitPrice: 9800,
              },
              {
                designation: "D√©pose C√¢ble Fibre toute capacit√©",
                unit: "u",
                unitPrice: 122,
              },
              {
                designation: "Plantation d'un Poteau Simple",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "Plantation d'un Poteau Mois√©",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "Redressement d'un Poteau existant",
                unit: "u",
                unitPrice: 3575,
              },
            ],
            "Prestations FTTH et Support": [
              {
                designation:
                  "Cr√©ation d'un nouvel abonn√© FTTH (mesures-installation-mise en service ONT)",
                unit: "u",
                unitPrice: 33250,
              },
              {
                designation:
                  "Rel√®ve d√©rangement FTTH (mesures-remplacement cable branchement-tout type raccordement installation-nettoyage)",
                unit: "u",
                unitPrice: 14573,
              },
              {
                designation:
                  "Cr√©ation d'un nouvel abonn√© (cas aussi de reprise abonn√© avec pose de c√¢ble de branchement y compris inst. int√©rieure)",
                unit: "u",
                unitPrice: 33250,
              },
              {
                designation: "Rel√®ve d√©rangement FTTH",
                unit: "u",
                unitPrice: 14573,
              },
              {
                designation:
                  "Raccordement au point d'acc√®s (PA) de deux abonn√©s par Manchon",
                unit: "u",
                unitPrice: 6000,
              },
              {
                designation: "Cr√©ation Point d'acc√®s (PA) pour un abonn√©",
                unit: "u",
                unitPrice: 10000,
              },
              {
                designation:
                  "Etablissement d'un plan itin√©raire G√©nie Civil, A√©rien et Souterrain, pour les travaux de construction",
                unit: "ff",
                unitPrice: 140000,
              },
              {
                designation:
                  "Reprise d'√©pissure/mesure/recette/r√©partition des fibres au niveau ODF",
                unit: "ff",
                unitPrice: 12000,
              },
              {
                designation:
                  "Reprise d'√©pissure / mesure / recette / r√©paration des fibres au niveau BPE/Boitier de r√©partition/PBO",
                unit: "ff",
                unitPrice: 8000,
              },
            ],
          },
        },
      };

      /**
       * G√©n√®re un ID unique et stable pour chaque √©l√©ment bas√© sur sa d√©signation.
       * Cet ID est utilis√© comme cl√© dans `currentQuantities` et comme ID HTML.
       */
      function getItemKey(designation) {
        return designation
          .toLowerCase()
          .replace(/[^a-z0-9]/g, "_") // Remplacer les caract√®res non alphanum√©riques par _
          .replace(/__/g, "_") // Supprimer les doubles underscores
          .substring(0, 50); // Limiter la longueur pour la s√©curit√©
      }

      /* ======================================================================
            FONCTIONS MODALES (Remplacement de alert)
            ====================================================================== */
      function showBOQAlert(title, message) {
        const modal = document.getElementById("custom-modal");
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-message").textContent = message;
        const actions = document.getElementById("modal-actions");
        actions.innerHTML = "";

        const okButton = document.createElement("button");
        okButton.className =
          "bg-moov-blue hover-bg-moov-orange text-white font-bold py-2 px-4 rounded-lg transition";
        okButton.textContent = "OK";
        okButton.onclick = () => modal.classList.add("hidden");
        actions.appendChild(okButton);

        modal.classList.remove("hidden");
      }

      /* ======================================================================
            LOGIQUE DE G√âN√âRATION DU TABLEAU ET DE CALCUL
            ====================================================================== */

      // Stockage interne pour les quantit√©s et les totaux
      let currentQuantities = {};

      // G√©n√®re TOUTES les lignes pour l'affichage √† l'√©cran
      function generateTableRows() {
        const tbody = document.getElementById("boq-body");
        tbody.innerHTML = "";

        for (const categoryKey in BOQ_STATIC_DATA) {
          const category = BOQ_STATIC_DATA[categoryKey];

          // Ligne de Cat√©gorie Principale (FOURNITURE / PRESTATION)
          const mainRow = tbody.insertRow();
          mainRow.className = "bg-moov-blue/10 main-category";
          mainRow.innerHTML = `<td colspan="5" class="px-3 py-2 text-left text-sm font-bold text-moov-blue">${category.title}</td>`;

          for (const subKey in category.subsections) {
            const subsection = category.subsections[subKey];

            // Ligne de Sous-Cat√©gorie
            const subRow = tbody.insertRow();
            subRow.className = "bg-gray-50 sub-category";
            subRow.innerHTML = `<td colspan="5" class="px-3 py-1 text-left text-xs font-semibold text-gray-700 italic">${subKey}</td>`;

            subsection.forEach((item) => {
              const itemIdCleaned = getItemKey(item.designation);
              const row = tbody.insertRow();
              row.id = `row-${itemIdCleaned}`;
              row.setAttribute("data-price", item.unitPrice);
              row.className = "boq-item-row"; // Classe pour toutes les lignes d'articles
              row.innerHTML = `
                            <td class="px-3 py-2 text-sm text-gray-700">${
                              item.designation
                            }</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${
                              item.unit
                            }</td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <input type="number" id="qty-${itemIdCleaned}" 
                                        min="0" step="0.01" 
                                        placeholder="0" 
                                        class="w-full text-right qty-input" 
                                        data-item-key="${itemIdCleaned}" 
                                        value="${
                                          currentQuantities[itemIdCleaned] || 0
                                        }"
                                        oninput="updateTotals(); saveBOQData();">
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm unit-price text-gray-600">${item.unitPrice.toLocaleString(
                              "fr-FR"
                            )}</td>
                            <td id="total-${itemIdCleaned}" class="px-3 py-2 whitespace-nowrap text-sm font-medium total-cell text-gray-800 text-right">0</td>
                        `;
            });
          }
        }
        updateTotals();
      }

      function updateTotals() {
        let grandTotal = 0;
        const inputs = document.querySelectorAll(".qty-input");

        inputs.forEach((input) => {
          const itemIdCleaned = input.getAttribute("data-item-key");
          const quantity = parseFloat(input.value) || 0;
          const row = document.getElementById(`row-${itemIdCleaned}`);

          if (!row) return;

          const unitPrice = parseFloat(row.getAttribute("data-price"));

          // Calcul du total de la ligne
          const total = Math.round(quantity * unitPrice);
          grandTotal += total;

          // Affichage du total de la ligne
          const totalCell = document.getElementById(`total-${itemIdCleaned}`);
          if (totalCell) {
            totalCell.textContent = total.toLocaleString("fr-FR");
          }

          // Mettre √† jour l'objet de quantit√©s pour la sauvegarde
          currentQuantities[itemIdCleaned] = quantity;
        });

        // Affichage du Grand Total
        document.getElementById("grand-total").textContent =
          grandTotal.toLocaleString("fr-FR") + " FCFA";
      }

      // ======================================================================
      // LOGIQUE D'IMPRESSION : Masquer les lignes de quantit√© 0
      // ======================================================================

      function prepareForPrint() {
        document.querySelectorAll(".boq-item-row").forEach((row) => {
          const itemIdCleaned = row.id.replace("row-", "");
          const quantity = currentQuantities[itemIdCleaned] || 0;

          if (quantity <= 0) {
            // Masquer la ligne si la quantit√© est z√©ro ou moins
            row.classList.add("print-hide");
          } else {
            // Afficher la ligne si la quantit√© est positive
            row.classList.remove("print-hide");
          }
        });

        // Logique pour afficher les cat√©gories/sous-cat√©gories UNIQUEMENT si elles contiennent au moins une ligne affich√©e.
        const allItems = document.querySelectorAll(".boq-item-row");

        // Masquer d'abord toutes les cat√©gories/sous-cat√©gories.
        document
          .querySelectorAll(".main-category, .sub-category")
          .forEach((header) => {
            header.classList.add("print-hide");
          });

        // Puis afficher seulement si une ligne d'article suit
        allItems.forEach((row) => {
          if (!row.classList.contains("print-hide")) {
            // Remonter jusqu'au parent pour afficher les en-t√™tes
            let tempRow = row.previousElementSibling;

            while (tempRow && tempRow.tagName === "TR") {
              tempRow.classList.remove("print-hide");
              if (tempRow.classList.contains("main-category")) {
                break; // Arr√™ter √† la cat√©gorie principale
              }
              tempRow = tempRow.previousElementSibling;
            }
          }
        });

        // Lancer l'impression apr√®s l'application des classes
        window.print();
      }

      /* ======================================================================
            FONCTIONS DE PERSISTENCE (LocalStorage)
            ====================================================================== */

      function loadReportInfo() {
        const savedReport = localStorage.getItem(REPORT_STORAGE_KEY);
        let liaison = "--",
          ticket = "--",
          zone = "--";

        if (savedReport) {
          const reportData = JSON.parse(savedReport);
          liaison = reportData["liaison-nom"] || "--";
          ticket = reportData["ticket-numero"] || "--";

          const selectedZone = reportData["zone-maintenance"] || "--";
          if (selectedZone === "AUTRE") {
            zone = reportData["zone-maintenance-autre"] || "AUTRE";
          } else {
            zone = selectedZone;
          }
        }

        document.getElementById("info-liaison").textContent = liaison;
        document.getElementById("info-ticket").textContent = ticket;
        document.getElementById("info-zone").textContent = zone;
      }

      function saveBOQData() {
        const boqData = {
          // Utiliser PROFORMA_REFERENCE_ID comme identifiant de BOQ pour l'historique
          proformaReferenceId: PROFORMA_REFERENCE_ID,
          quantities: currentQuantities,
        };
        localStorage.setItem(BOQ_STORAGE_KEY, JSON.stringify(boqData));
      }

      function loadBOQData() {
        const savedData = localStorage.getItem(BOQ_STORAGE_KEY);
        if (!savedData) return;

        const boqData = JSON.parse(savedData);

        // Charge les quantit√©s uniquement si elles correspondent au m√™me rapport
        if (boqData.proformaReferenceId === PROFORMA_REFERENCE_ID) {
          currentQuantities = boqData.quantities || {};
        } else {
          // Si la r√©f√©rence a chang√©, on part d'un BOQ vide pour cette nouvelle r√©f√©rence
          currentQuantities = {};
          // On ne supprime pas la cl√© car elle pourrait √™tre associ√©e √† un autre rapport
        }
      }

      function displayReference() {
        // Pas d'affichage de r√©f√©rence demand√©, mais la fonction est conserv√©e au cas o√π
        const refDisplay = document.getElementById("report-reference");
        if (refDisplay) {
          refDisplay.style.display = "none";
        }
      }

      /* ======================================================================
            INITIALISATION
            ====================================================================== */

      document.addEventListener("DOMContentLoaded", () => {
        loadReportInfo(); // Charge et affiche les infos du rapport
        displayReference();
        loadBOQData(); // Charge les quantit√©s si elles existent
        generateTableRows(); // G√©n√®re le tableau avec les quantit√©s charg√©es
        updateTotals(); // Calcule et affiche les totaux
      });
    </script>
  </body>
</html>
