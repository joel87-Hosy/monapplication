<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ITC FiberOps - V45.24 Administration & Nettoyage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha255-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha255-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap");

      /* CORRECTION 3: Autoriser le défilement global sur le body */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        overflow-x: hidden; /* Empêche le défilement horizontal non désiré */
        overflow-y: auto; /* Permet le défilement vertical */
      }

      /* CORRECTION 3: Autoriser le défilement global sur l'app wrapper */
      #app-wrapper {
        display: none;
        flex: 1;
        height: 100%;
        width: 100%;
        overflow: visible; /* Laisser le body gérer le défilement */
      }
      #app-wrapper.visible {
        display: flex;
      }

      /* --- 1. LOGIN --- */
      #login-overlay {
        position: fixed;
        inset: 0;
        background: #0f172a;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #login-overlay.hidden {
        display: none !important;
      }
      .login-box {
        background: white;
        padding: 2.5rem;
        width: 420px;
        text-align: center;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      /* --- 2. UI COCKPIT --- */
      .cockpit-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s;
      }
      .cockpit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .cockpit-icon-bg {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }
      .ai-card {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        position: relative;
        overflow: hidden;
        border: none;
      }
      .ai-card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: radial-gradient(
          circle,
          rgba(59, 130, 246, 0.3) 0%,
          transparent 70%
        );
      }
      .trend-up {
        color: #f87171;
      }
      .trend-down {
        color: #4ade80;
      }
      .qhse-card {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border: 1px solid #fed7aa;
      }

      /* --- 3. MOTEUR D'IMPRESSION V45.24 --- */
      .a4-page {
        width: 210mm;
        height: 297mm; /* Hauteur FIXE A4 */
        background: white;
        margin: 0 auto 30px auto;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        padding: 20mm;
        box-sizing: border-box;
        overflow: hidden;
      }

      .header-logos-container {
        position: absolute;
        top: 15mm;
        left: 15mm;
        right: 15mm;
        height: 60px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
        pointer-events: none;
      }
      .header-logo-img {
        height: 60px;
        object-fit: contain;
      }
      .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        opacity: 0.08;
        width: 70%;
        z-index: 0;
        pointer-events: none;
        filter: grayscale(100%);
      }
      .page-number {
        position: absolute;
        bottom: 10mm;
        right: 20mm;
        font-size: 10px;
        color: #94a3b8;
        font-weight: bold;
      }

      .report-content-safe-zone {
        position: relative;
        z-index: 10;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* BLOCS DE CONTENU */
      .report-block {
        margin-bottom: 10px;
        break-inside: avoid;
      }

      /* STYLES INTERNES */
      .cover-title {
        font-size: 3rem;
        font-weight: 900;
        color: #0f172a;
        text-transform: uppercase;
        line-height: 1.1;
        text-align: center;
        margin-bottom: 2rem;
      }
      .cover-liaison {
        font-size: 1.8rem;
        color: #db2777;
        font-weight: 800;
        border-top: 4px solid #0f172a;
        border-bottom: 4px solid #0f172a;
        padding: 20px;
        background: #f8fafc;
        width: 100%;
        text-align: center;
        margin-bottom: 2rem;
      }
      .section-header {
        background: #1e293b;
        color: white;
        padding: 6px 10px;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        border-radius: 4px;
        margin: 15px 0 8px 0;
        break-after: avoid;
      }

      .data-table,
      .boq-table,
      .invoice-table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 10px;
        margin-top: 4px;
        break-inside: avoid;
      }
      .data-table th {
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        padding: 5px;
        font-weight: bold;
        color: #334155;
      }
      .data-table td {
        border: 1px solid #cbd5e1;
        padding: 5px;
        color: #334155;
        word-wrap: break-word;
      }

      .photo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 8px;
        break-inside: avoid;
      }
      .photo-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 8px;
        break-inside: avoid;
      }
      .photo-container {
        width: 100%;
        height: 200px;
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .photo-container-small {
        width: 100%;
        height: 150px;
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .photo-container img,
      .photo-container-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .section-comment {
        font-size: 11px;
        color: #4b5563;
        font-style: italic;
        margin-top: 4px;
        background: #f1f5f9;
        padding: 6px;
        border-left: 3px solid #db2777;
      }

      .map-box {
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
        background: #f8fafc;
        display: flex;
        break-inside: avoid;
      }
      .map-visual {
        width: 120px;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 2rem;
      }
      .map-details {
        padding: 10px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .form-input {
        width: 100%;
        border: 1px solid #cbd5e1;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .form-section-title {
        background: #db2777;
        color: white;
        padding: 8px;
        font-weight: bold;
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 0.8rem;
        border-radius: 4px;
        text-transform: uppercase;
      }

      /* Mode Plein Écran */
      body.fullscreen-preview #form-panel {
        display: none;
      }
      body.fullscreen-preview #preview-panel {
        width: 100%;
        padding: 40px;
        align-items: center;
      }

      /* Carte Leaflet */
      #interactive-map {
        height: 100%;
        width: 100%;
        z-index: 1;
      }
      .leaflet-popup-content-wrapper {
        border-radius: 8px;
        font-family: "Inter", sans-serif;
        font-size: 12px;
      }

      /* AJOUT POUR RESPONSIVENESS (Sidebar Mobile) */
      #app-sidebar.active {
        display: flex !important;
        position: fixed;
        height: 100%;
        z-index: 50;
        left: 0;
        top: 0;
        transform: translateX(0);
        transition: transform 0.3s ease-out;
      }

      /* CORRECTION 1 & 2: Ajuster la vue d'édition et la vue facture pour le responsive */
      #view-editor,
      #view-invoice {
        /* Par défaut, permet le défilement et la colonne sur mobile */
        height: auto;
        flex-direction: column;
      }

      @media (min-width: 1280px) {
        /* XL breakpoint (Desktop) */
        #view-editor,
        #view-invoice {
          flex-direction: row;
          height: calc(100vh - 100px); /* Hauteur fixe pour le mode desktop */
        }
      }

      #form-panel {
        width: 100%; /* Formulaire prend toute la largeur sur mobile */
        flex-shrink: 0;
      }

      @media (min-width: 1280px) {
        #form-panel {
          width: 420px; /* Largeur fixe sur desktop */
        }
      }

      /* --- PRINT (Ancienne méthode, laissée en cas de besoin) --- */
      @media print {
        @page {
          margin: 0;
          size: A4;
        }
        html,
        body {
          height: auto !important;
          overflow: visible !important;
        }
        body {
          background: white;
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
        }

        /* Masque la navigation et les formulaires */
        aside,
        #login-overlay,
        #form-panel,
        #view-dashboard,
        #view-incidents,
        #view-history,
        #view-invoices-list,
        #view-map,
        .no-print,
        #view-admin-users {
          display: none !important;
        }

        /* V45.22: Cible le wrapper global et le main pour garantir un flux vertical */
        #app-wrapper,
        main {
          display: block !important;
          height: auto !important;
          overflow: visible !important;
        }

        /* S'assure que les vues d'édition/facture sont visibles et neutralise le FLEX sur le conteneur principal */
        #view-editor:not(.hidden),
        #view-invoice:not(.hidden) {
          display: block !important;
          width: 100% !important;
          height: auto !important;
          flex-direction: initial !important;
        }

        /* S'assure que le contenu principal est visible et que le panneau d'aperçu prend toute la place */
        #main-container {
          padding: 0 !important;
          margin: 0 !important;
          height: auto !important;
          overflow: visible !important;
        }

        /* Panneau d'aperçu des Rapports/Factures */
        #preview-panel,
        #invoice-preview-panel {
          padding: 0 !important;
          background: white !important;
          box-shadow: none !important;
          margin: 0 !important;
          width: 100% !important;
          overflow: visible !important;
          height: auto !important;
        }

        /* Le conteneur de toutes les pages A4 doit être BLOCK pour une pagination fiable */
        #report-pages-container {
          display: block !important;
          flex-direction: initial !important;
        }

        .a4-page {
          margin: 0 !important;
          padding: 15mm !important;
          width: 210mm !important;
          height: 297mm !important;
          page-break-after: always;
          position: relative !important;
          box-shadow: none !important;
          border: none !important;
        }
        .a4-page:last-child {
          page-break-after: auto;
        }
        .watermark {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-45deg);
          z-index: -1;
          opacity: 0.08;
          width: 70%;
          display: block !important;
        }
      }
    </style>
  </head>
  <body class="flex h-screen w-screen">
    <div id="login-overlay">
      <div class="login-box">
        <h1 class="text-4xl font-black text-pink-600 mb-2 tracking-tighter">
          ITC <span class="text-slate-800 font-light">Genesis</span>
        </h1>
        <p
          class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-8"
        >
          V45.24 Administration & Nettoyage
        </p>
        <div class="space-y-4">
          <input
            type="text"
            id="login-user"
            class="form-input text-center text-lg font-bold"
            placeholder="Identifiant"
            value="manager"
          />
          <input
            type="password"
            id="login-pass"
            class="form-input text-center text-lg font-bold"
            placeholder="Mot de passe"
            value="admin"
          />
          <button
            onclick="login()"
            class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg transform active:scale-95"
          >
            ACCÉDER AU COCKPIT
          </button>
        </div>
        <div
          class="mt-6 pt-4 border-t border-gray-100 flex justify-between text-[10px] text-gray-400"
        >
          <span
            >Défaut: manager / admin | Validateur: client_validator /
            client123</span
          >
          <button
            onclick="resetApp()"
            class="text-red-400 hover:text-red-600 underline"
          >
            Reset App
          </button>
        </div>
      </div>
    </div>

    <div id="app-wrapper" class="flex flex-1 w-screen">
      <aside
        id="app-sidebar"
        class="w-72 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-20 no-print"
      >
        <div class="p-6 text-center border-b border-slate-800 bg-slate-950">
          <h1 class="text-2xl font-black text-pink-500 tracking-tight">
            ITC <span class="text-white font-light">FiberOps</span>
          </h1>
          <div
            class="mt-3 flex items-center justify-center gap-2 bg-slate-800 py-1 px-3 rounded-full mx-auto w-fit"
          >
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="current-username" class="text-xs font-bold text-gray-300"
              >...</span
            >
          </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
          <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mt-2">
            Pilotage
          </p>
          <button
            onclick="switchView('dashboard')"
            class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
          >
            <i class="fas fa-tachometer-alt w-5 text-blue-400"></i> Cockpit
          </button>
          <button
            onclick="switchView('incidents')"
            class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
          >
            <i class="fas fa-exclamation-triangle w-5 text-red-400"></i>
            Incidents
          </button>
          <button
            onclick="switchView('history')"
            class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
          >
            <i class="fas fa-folder-open w-5 text-purple-400"></i> Archives
          </button>

          <div class="my-4 border-t border-slate-800 pt-2">
            <button
              onclick="startNewReport('incident')"
              class="w-full text-left p-3 rounded-xl transition flex items-center justify-center gap-2 bg-pink-600 hover:bg-pink-500 text-white font-bold shadow-lg shadow-pink-900/20 mb-2"
            >
              <i class="fas fa-plus-circle"></i> Nouveau Rapport
            </button>
            <button
              onclick="startNewReport('survey_terrain')"
              class="w-full text-left p-3 rounded-xl transition flex items-center justify-center gap-2 bg-pink-500 hover:bg-pink-400 text-white font-bold shadow-lg shadow-pink-900/20 mb-2"
            >
              <i class="fas fa-search-location"></i> Survey Terrain
            </button>
            <button
              onclick="switchView('map')"
              class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 bg-slate-800 text-white border border-slate-700 hover:border-orange-500"
            >
              <i class="fas fa-map-marked-alt w-5 text-orange-400"></i>
              Cartographie
            </button>
          </div>

          <div class="restricted-finance pt-4 border-t border-slate-800 mt-4">
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mb-2">
              Finance & Admin
            </p>
            <button
              onclick="switchView('invoices-list')"
              class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
            >
              <i class="fas fa-file-invoice-dollar w-5 text-green-400"></i>
              Proformas
            </button>
            <button
              onclick="startNewInvoice()"
              class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
            >
              <i class="fas fa-cart-plus w-5 text-green-200"></i> Créer Proforma
            </button>
          </div>

          <div class="restricted-admin pt-4 border-t border-slate-800 mt-4">
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase mb-2">
              Configuration
            </p>
            <button
              onclick="switchView('admin-users')"
              class="nav-btn w-full text-left p-3 rounded-xl transition flex items-center gap-3 hover:bg-slate-800 text-slate-300 hover:text-white"
            >
              <i class="fas fa-users-cog w-5 text-yellow-400"></i>
              Administration
            </button>
          </div>
        </nav>
        <div class="p-4 border-t border-slate-800">
          <button
            onclick="logout()"
            class="w-full flex items-center justify-center gap-2 text-xs font-bold text-red-400 hover:text-red-300 bg-slate-800/50 p-3 rounded-lg hover:bg-slate-800 transition"
          >
            <i class="fas fa-power-off"></i> DÉCONNEXION
          </button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col relative bg-slate-50">
        <button
          onclick="toggleSidebar()"
          id="mobile-menu-btn"
          class="fixed top-4 left-4 z-50 p-3 bg-slate-900 text-white rounded-xl shadow-lg md:hidden"
        >
          <i class="fas fa-bars"></i>
        </button>

        <div id="main-container" class="flex-1 overflow-y-auto p-6 md:p-8">
          <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto">
            <div class="flex justify-between items-end">
              <div>
                <h2 class="text-3xl font-black text-slate-800 tracking-tight">
                  Cockpit de Pilotage
                </h2>
                <p class="text-sm text-slate-500 font-medium mt-1">
                  Vue d'overview des opérations V45
                </p>
              </div>
              <span
                class="text-xs font-bold bg-white px-3 py-1 rounded-full text-slate-400 border border-slate-200 shadow-sm"
                ><i class="fas fa-clock mr-1"></i> Temps réel</span
              >
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="cockpit-card">
                <div class="flex justify-between items-start">
                  <div>
                    <p
                      class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                    >
                      Rapports
                    </p>
                    <h3
                      class="text-4xl font-black text-slate-800 mt-2"
                      id="dash-total"
                    >
                      0
                    </h3>
                  </div>
                  <div class="cockpit-icon-bg bg-blue-50 text-blue-600">
                    <i class="fas fa-file-contract"></i>
                  </div>
                </div>
              </div>
              <div class="cockpit-card ai-card">
                <div class="relative z-10">
                  <p
                    class="text-xs font-bold text-blue-200 uppercase tracking-wider flex items-center gap-2"
                  >
                    <i class="fas fa-robot"></i> Prédiction IA
                  </p>
                  <h3
                    class="text-2xl font-bold text-white mt-3 leading-none"
                    id="ai-pred-val"
                  >
                    --
                  </h3>
                  <p
                    class="text-[10px] text-blue-100 mt-2 opacity-80"
                    id="ai-trend-text"
                  >
                    Analyse...
                  </p>
                </div>
              </div>
              <div class="cockpit-card">
                <div class="flex justify-between items-start">
                  <div>
                    <p
                      class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                    >
                      Top Performer
                    </p>
                    <h3
                      class="text-lg font-bold text-slate-800 mt-2 truncate"
                      id="dash-top-perf"
                    >
                      --
                    </h3>
                  </div>
                  <div class="cockpit-icon-bg bg-yellow-50 text-yellow-600">
                    <i class="fas fa-trophy"></i>
                  </div>
                </div>
              </div>
              <div class="cockpit-card qhse-card">
                <div>
                  <p
                    class="text-xs font-bold text-orange-600 uppercase flex items-center gap-2 mb-2"
                  >
                    <i class="fas fa-hard-hat"></i> QHSE Flash
                  </p>
                  <p
                    class="text-sm text-slate-800 font-medium italic leading-snug"
                    id="qhse-tip"
                  >
                    "..."
                  </p>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-80">
              <div
                class="col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col"
              >
                <h3 class="text-sm font-bold text-slate-700 uppercase mb-4">
                  Évolution Incidents
                </h3>
                <div class="flex-1 relative">
                  <canvas id="recurrenceChart"></canvas>
                </div>
              </div>
              <div
                class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col restricted-finance"
              >
                <h3 class="text-sm font-bold text-slate-700 uppercase mb-4">
                  Finance
                </h3>
                <div class="flex-1 relative flex justify-center">
                  <canvas id="financeChart"></canvas>
                </div>
                <div class="text-center mt-2">
                  <span
                    class="text-2xl font-black text-slate-800"
                    id="donut-total"
                    >0</span
                  ><span class="text-xs text-gray-400 block uppercase font-bold"
                    >Total Proformé</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div id="view-incidents" class="hidden max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800">
                Suivi des Incidents
              </h2>
              <button
                onclick="exportCSV()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow transition"
              >
                <i class="fas fa-file-excel mr-2"></i>Export
              </button>
            </div>
            <div
              class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
            >
              <table class="w-full text-sm text-left">
                <thead
                  class="bg-slate-50 uppercase text-xs text-slate-500 font-bold border-b"
                >
                  <tr>
                    <th class="px-6 py-4">Date</th>
                    <th class="px-6 py-4">Liaison</th>
                    <th class="px-6 py-4">Code / Intervenant</th>
                    <th class="px-6 py-4">Statut</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody
                  id="incidents-list-body"
                  class="divide-y divide-slate-100"
                ></tbody>
              </table>
            </div>
          </div>

          <div
            id="view-map"
            class="hidden h-[calc(100vh-80px)] w-full flex flex-col"
          >
            <div class="flex justify-between items-center mb-4 px-2">
              <h2 class="text-2xl font-bold text-slate-800">
                Cartographie Interactive
              </h2>
              <span class="text-xs font-bold text-slate-400"
                >OpenStreetMap Data</span
              >
            </div>
            <div
              class="flex-1 bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex flex-col md:flex-row relative"
            >
              <div
                class="w-full md:w-80 bg-slate-50 border-r border-slate-200 flex flex-col z-10"
              >
                <div
                  class="p-3 bg-white border-b border-slate-200 font-bold text-xs uppercase text-slate-500"
                >
                  Points Enregistrés
                </div>
                <div
                  id="map-sidebar-list"
                  class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2"
                ></div>
              </div>
              <div class="flex-1 relative z-0">
                <div id="interactive-map"></div>
              </div>
            </div>
          </div>

          <div id="view-editor" class="hidden flex flex-col gap-6 xl:flex-row">
            <div
              id="form-panel"
              class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 w-full xl:w-[420px] overflow-y-auto custom-scrollbar flex flex-col no-print"
            >
              <div
                class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"
              >
                <h3 class="text-lg font-black text-slate-800">
                  Éditeur Expert
                </h3>
                <button
                  onclick="switchView('dashboard')"
                  class="text-slate-400 hover:text-red-500 transition"
                >
                  <i class="fas fa-times-circle text-xl"></i>
                </button>
              </div>
              <div class="space-y-4 flex-1">
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                  <label
                    class="block text-[10px] font-bold text-slate-400 uppercase mb-1"
                    >Type de Rapport</label
                  >
                  <select
                    id="report-type"
                    onchange="renderForm()"
                    class="w-full bg-white border border-slate-300 text-slate-800 font-bold rounded p-2 text-sm focus:ring-2 focus:ring-pink-500 outline-none"
                  >
                    <option value="incident">INCIDENT</option>
                    <option value="surveillance">SURVEILLANCE</option>
                    <option value="survey_terrain">SURVEY TERRAIN</option>
                    <option value="normalisation">NORMALISATION</option>
                    <option value="mise_a_dispo">MISE À DISPOSITION</option>
                    <option value="otdr">MESURES OTDR</option>
                  </select>
                </div>
                <div id="dynamic-form-fields" class="space-y-4"></div>
              </div>
              <div
                class="mt-6 pt-4 border-t border-slate-100 space-y-3 bg-white sticky bottom-0 z-10"
              >
                <button
                  onclick="toggleFullscreenPreview()"
                  id="btn-fullscreen"
                  class="w-full bg-slate-100 text-slate-700 border border-slate-300 p-2 rounded-lg font-bold text-sm hover:bg-slate-200 transition mb-2"
                >
                  <i class="fas fa-expand mr-2"></i>Mode Aperçu Plein Écran
                </button>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="btn-pdf-editor"
                    onclick="generatePDF(document.getElementById('report-type').value, document.getElementById('inp_report_code').value)"
                    class="bg-slate-800 text-white p-3 rounded-lg font-bold text-sm hover:bg-slate-700 transition"
                  >
                    <i class="fas fa-file-pdf mr-2"></i>PDF
                  </button>
                  <button
                    onclick="saveReport()"
                    class="bg-blue-600 text-white p-3 rounded-lg font-bold text-sm hover:bg-blue-500 transition"
                  >
                    <i class="fas fa-save mr-2"></i>Sauver
                  </button>
                </div>
                <button
                  onclick="switchToInvoiceFromReport()"
                  class="w-full bg-green-50 text-green-700 border border-green-200 p-3 rounded-lg font-bold text-sm hover:bg-green-100 transition restricted-finance"
                >
                  <i class="fas fa-file-invoice mr-2"></i>Générer Proforma
                </button>
              </div>
            </div>

            <div
              id="preview-panel"
              class="flex-1 bg-slate-200/50 p-8 rounded-xl overflow-y-auto flex flex-col items-center gap-8 shadow-inner border border-slate-200/60 custom-scrollbar"
            >
              <div
                id="report-pages-container"
                class="flex flex-col gap-8 w-full items-center"
              ></div>
            </div>
          </div>

          <div
            id="view-invoice"
            class="hidden flex flex-col gap-6 restricted-finance xl:flex-row"
          >
            <div
              class="w-full xl:w-[380px] bg-white p-6 rounded-xl shadow-lg border border-slate-100 overflow-y-auto no-print"
            >
              <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h3 class="text-lg font-black text-slate-800">Proforma</h3>
                <button
                  onclick="switchView('invoices-list')"
                  class="text-slate-400"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <div class="space-y-3">
                <select
                  id="inv-status"
                  class="form-input font-bold"
                  onchange="upInv()"
                >
                  <option value="En attente">En attente</option>
                  <option value="Proformé">Proformé</option>
                  <option value="Validé">Validé</option>
                  <option value="Annulé">Annulé</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                  <input
                    id="inv-num"
                    class="form-input"
                    placeholder="N°"
                    oninput="upInv()"
                  /><input
                    type="date"
                    id="inv-date"
                    class="form-input"
                    onchange="upInv()"
                  />
                </div>
                <textarea
                  id="inv-client"
                  class="form-input h-20"
                  oninput="upInv()"
                >
MOOV AFRICA CI
Abidjan, Plateau</textarea
                >
                <input
                  id="inv-ref"
                  class="form-input"
                  placeholder="Objet"
                  oninput="upInv()"
                />
              </div>

              <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs text-pink-600 mb-2">
                  SIGNATURES CLIENT (MOOV)
                </h4>
                <input
                  id="inv-sign-client-name"
                  class="form-input"
                  placeholder="Nom du Signataire Client"
                  oninput="upInv()"
                />
                <input
                  id="inv-sign-client-func"
                  class="form-input"
                  placeholder="Fonction du Signataire Client"
                  oninput="upInv()"
                />

                <h4 class="font-bold text-xs text-pink-600 mt-4 mb-2">
                  SIGNATURE ITC
                </h4>
                <input
                  id="inv-sign-itc-name"
                  class="form-input"
                  placeholder="Nom du Signataire ITC"
                  value="Jean DUPONT"
                  oninput="upInv()"
                />
                <input
                  id="inv-sign-itc-func"
                  class="form-input"
                  placeholder="Fonction du Signataire ITC"
                  value="Manager Opérationnel"
                  oninput="upInv()"
                />
              </div>

              <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs text-pink-600 mb-2">
                  LIGNES DE PROFORMA
                </h4>
                <div id="inv-items-editor" class="space-y-2 mb-2"></div>
                <div class="grid grid-cols-2 gap-2">
                  <button
                    onclick="addInvItem('Fourniture')"
                    class="w-full bg-blue-100 text-blue-700 text-xs font-bold py-2 rounded hover:bg-blue-200 flex items-center justify-center gap-1"
                  >
                    <i class="fas fa-plus"></i> Fourniture
                  </button>
                  <button
                    onclick="addInvItem('Prestation')"
                    class="w-full bg-purple-100 text-purple-700 text-xs font-bold py-2 rounded hover:bg-purple-200 flex items-center justify-center gap-1"
                  >
                    <i class="fas fa-plus"></i> Prestation
                  </button>
                </div>
              </div>
              <div class="mt-6 pt-4 border-t border-slate-100 space-y-3">
                <button
                  onclick="approveInvoice()"
                  id="btn-approve-invoice"
                  class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-500 transition hidden"
                >
                  <i class="fas fa-check-circle mr-2"></i> VALIDER ET
                  TRANSMETTRE
                </button>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="btn-pdf-editor"
                    onclick="generatePDF(document.getElementById('report-type').value, document.getElementById('inp_liaison').value)"
                    class="bg-slate-800 text-white p-3 rounded-lg font-bold text-sm hover:bg-slate-700 transition"
                  >
                    <i class="fas fa-file-pdf mr-2"></i>PDF
                  </button>
                  <button
                    onclick="saveInvoice()"
                    class="bg-green-600 text-white p-3 rounded font-bold"
                  >
                    SAUVER
                  </button>
                </div>
              </div>
            </div>
            <div
              id="invoice-preview-panel"
              class="flex-1 bg-slate-200/50 p-8 rounded-xl overflow-y-auto flex justify-center"
            >
              <div
                class="a4-page flex flex-col justify-between"
                id="invoice-page"
              >
                <img
                  src="LOGO ITC.png"
                  class="watermark"
                  onerror="this.style.display='none'"
                />
                <div class="header-logos-container">
                  <img src="LOGO ITC.png" class="header-logo-img" /><img
                    src="logo MOOV.png"
                    class="header-logo-img"
                  />
                </div>
                <div class="report-content-safe-zone flex flex-col h-full">
                  <div class="flex-1">
                    <div style="padding-top: 80px"></div>
                    <div class="flex justify-between items-start mb-8 mt-4">
                      <div>
                        <h1
                          class="text-4xl font-black text-slate-800 tracking-tight"
                        >
                          PROFORMA
                        </h1>
                        <p class="text-slate-500 font-medium">
                          N° <span id="prev-inv-num">...</span>
                        </p>
                        <p class="text-sm text-slate-400">
                          Date: <span id="prev-inv-date">...</span>
                        </p>
                      </div>
                      <div
                        id="prev-inv-status"
                        class="px-4 py-1 border-2 border-slate-800 rounded font-bold uppercase text-sm transform -rotate-6"
                      >
                        EN ATTENTE
                      </div>
                    </div>
                    <div class="flex justify-between mb-10">
                      <div class="w-5/12 text-sm text-slate-600">
                        <p class="font-bold text-slate-900 mb-1">Émetteur:</p>
                        <p>ITC Ivoire Techno Com</p>
                        <p>Abidjan, Côte d'Ivoire</p>
                      </div>
                      <div
                        class="w-5/12 bg-slate-50 p-4 rounded-lg border border-slate-100"
                      >
                        <p class="font-bold text-slate-900 mb-1">Adressé à :</p>
                        <p
                          class="text-sm whitespace-pre-line text-slate-600"
                          id="prev-inv-client"
                        >
                          ...
                        </p>
                      </div>
                    </div>
                    <div class="mb-6 pb-2 border-b border-slate-200">
                      <p class="font-bold text-sm text-slate-800">
                        Objet :
                        <span
                          id="prev-inv-ref"
                          class="font-normal text-slate-600"
                          >...</span
                        >
                      </p>
                    </div>
                    <table class="invoice-table w-full">
                      <thead>
                        <tr class="bg-slate-100 text-slate-700">
                          <th class="w-1/2 text-left pl-2">Description</th>
                          <th class="w-16 text-center">Qté</th>
                          <th class="w-24 text-right">P.U.</th>
                          <th class="w-24 text-right pr-2">Total H.T.</th>
                        </tr>
                      </thead>
                      <tbody id="prev-inv-items"></tbody>
                    </table>
                  </div>

                  <div class="mt-8">
                    <div class="flex justify-end">
                      <div class="w-1/2">
                        <div
                          class="flex justify-between py-1 border-b border-slate-100 text-sm font-bold text-blue-600"
                        >
                          <span>Sous-Total Fourniture</span
                          ><span id="prev-subtotal-fourniture">0 FCFA</span>
                        </div>
                        <div
                          class="flex justify-between py-1 border-b border-slate-100 text-sm font-bold text-purple-600"
                        >
                          <span>Sous-Total Prestation</span
                          ><span id="prev-subtotal-prestation">0 FCFA</span>
                        </div>
                        <div
                          class="flex justify-between py-2 border-b border-slate-100 text-sm"
                        >
                          <span>Total H.T.</span
                          ><span id="prev-total-ht" class="font-black"
                            >0 FCFA</span
                          >
                        </div>
                        <div
                          class="flex justify-between py-3 text-xl font-black text-slate-800 bg-slate-50 px-2 mt-2 rounded"
                        >
                          <span>TOTAL</span
                          ><span id="prev-total-ttc">0 FCFA</span>
                        </div>
                        <div
                          class="mt-4 p-2 bg-pink-50 text-pink-800 text-xs font-bold rounded italic border border-pink-200"
                        >
                          Arrêté le présent Proforma à la somme de :
                          <span id="prev-total-words" class="uppercase"
                            >ZÉRO FRANCS CFA</span
                          >
                        </div>
                      </div>
                    </div>

                    <div
                      class="flex justify-between items-start mb-10 pt-4 mt-8 border-t border-slate-300"
                    >
                      <div class="w-5/12 text-center">
                        <p class="text-xs font-bold text-slate-700 mb-2">
                          POUR LE CLIENT MOOV AFRICA CI
                        </p>
                        <div
                          class="h-16 border-b border-gray-400 mb-2 bg-slate-100/50 flex items-center justify-center text-xs italic text-gray-500"
                        >
                          Signature Digitale
                        </div>
                        <p class="text-xs font-bold" id="prev-sign-client-name">
                          NOM & PRÉNOM
                        </p>
                        <p
                          class="text-[10px] text-slate-500"
                          id="prev-sign-client-func"
                        >
                          Fonction
                        </p>
                      </div>
                      <div class="w-5/12 text-center">
                        <p class="text-xs font-bold text-slate-700 mb-2">
                          POUR ITC IVOIRE TECHNO COM
                        </p>
                        <div
                          class="h-16 border-b border-gray-400 mb-2 bg-slate-100/50 flex items-center justify-center text-xs italic text-gray-500"
                        >
                          Signature Digitale
                        </div>
                        <p class="text-xs font-bold" id="prev-sign-itc-name">
                          NOM & PRÉNOM
                        </p>
                        <p
                          class="text-[10px] text-slate-500"
                          id="prev-sign-itc-func"
                        >
                          Fonction
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="view-history" class="hidden">
            <div class="max-w-7xl mx-auto">
              <h2 class="text-2xl font-bold mb-4">Historique Global</h2>
              <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                  <thead
                    class="bg-slate-50 uppercase text-xs font-bold text-slate-500"
                  >
                    <tr>
                      <th class="p-4">Date</th>
                      <th class="p-4">Type</th>
                      <th class="p-4">Code / Intervenant</th>
                      <th class="p-4 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="full-history-body"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="view-invoices-list" class="hidden restricted-finance">
            <div class="max-w-7xl mx-auto">
              <h2 class="text-2xl font-bold mb-4">Proformas</h2>
              <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                  <thead
                    class="bg-slate-50 uppercase text-xs font-bold text-slate-500"
                  >
                    <tr>
                      <th class="p-4">Date</th>
                      <th class="p-4">N°</th>
                      <th class="p-4">Client</th>
                      <th class="p-4">Total</th>
                      <th class="p-4">Statut</th>
                      <th class="p-4 text-right">Action</th>
                    </tr>
                  </thead>
                  <tbody id="full-invoices-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div
            id="view-admin-users"
            class="hidden restricted-admin max-w-7xl mx-auto"
          >
            <h2 class="text-2xl font-bold text-slate-800 mb-6">
              Administration des Utilisateurs
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div
                class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 h-fit"
              >
                <h3 class="text-lg font-black text-pink-600 mb-4 border-b pb-2">
                  Créer un Nouvel Utilisateur
                </h3>
                <div class="space-y-3">
                  <input
                    type="text"
                    id="admin-user-id"
                    class="form-input"
                    placeholder="Identifiant (ex: tech2)"
                  />
                  <input
                    type="password"
                    id="admin-user-pass"
                    class="form-input"
                    placeholder="Mot de passe"
                  />
                  <select id="admin-user-role" class="form-input font-bold">
                    <option value="technicien">Technicien</option>
                    <option value="manager">Manager</option>
                    <option value="validator">Validateur (Client)</option>
                  </select>
                  <button
                    onclick="addUser()"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-500 transition"
                  >
                    <i class="fas fa-user-plus mr-2"></i> Ajouter l'utilisateur
                  </button>
                </div>
              </div>

              <div
                class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden"
              >
                <h3 class="text-lg font-black text-slate-800 p-4 border-b">
                  Liste des Comptes
                </h3>
                <table class="w-full text-sm text-left">
                  <thead
                    class="bg-slate-50 uppercase text-xs font-bold text-slate-500"
                  >
                    <tr>
                      <th class="p-4">Identifiant</th>
                      <th class="p-4">Rôle</th>
                      <th class="p-4 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="admin-users-list"></tbody>
                </table>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-lg border border-slate-100 mt-6 overflow-hidden"
            >
              <h3 class="text-lg font-black text-slate-800 p-4 border-b">
                Droits et Permissions
              </h3>
              <table class="w-full text-xs text-left">
                <thead class="bg-slate-50 uppercase font-bold text-slate-500">
                  <tr>
                    <th class="p-3 w-1/3">Action / Module</th>
                    <th class="p-3 text-center text-blue-600">Technicien</th>
                    <th class="p-3 text-pink-600">Manager (Admin)</th>
                    <th class="p-3 text-green-600">Validateur (Client)</th>
                  </tr>
                </thead>
                <tbody id="permissions-table-body">
                  <tr>
                    <td class="p-3 border-b">Créer / Modifier un Rapport</td>
                    <td class="text-center">
                      <i class="fas fa-check text-blue-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-times text-red-500"></i></td>
                  </tr>
                  <tr>
                    <td class="p-3 border-b">Accès au Cockpit & Archive</td>
                    <td class="text-center">
                      <i class="fas fa-check text-blue-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-check text-green-500"></i></td>
                  </tr>
                  <tr>
                    <td class="p-3 border-b">Accès Finance (Proforma)</td>
                    <td class="text-center">
                      <i class="fas fa-times text-red-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-check text-green-500"></i></td>
                  </tr>
                  <tr>
                    <td class="p-3 border-b">Créer / Modifier un Proforma</td>
                    <td class="text-center">
                      <i class="fas fa-times text-red-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-times text-red-500"></i></td>
                  </tr>
                  <tr>
                    <td class="p-3 border-b">
                      Valider un Proforma (Finaliser)
                    </td>
                    <td class="text-center">
                      <i class="fas fa-times text-red-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-check text-green-500"></i></td>
                  </tr>
                  <tr>
                    <td class="p-3 border-b font-bold">Accès Administration</td>
                    <td class="text-center">
                      <i class="fas fa-times text-red-500"></i>
                    </td>
                    <td><i class="fas fa-check text-pink-500"></i></td>
                    <td><i class="fas fa-times text-red-500"></i></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
    <datalist id="price-list-options"></datalist>

    <script>
      /* --- V45 ENGINE --- */
      let APP_DATA = {
        reports: JSON.parse(localStorage.getItem("itc_reports_v34")) || [],
        invoices: JSON.parse(localStorage.getItem("itc_invoices_v1")) || [],
        prices: JSON.parse(localStorage.getItem("itc_prices_v11")) || [
          { desc: "Soudure FO", price: 5000 },
          { desc: "Pose Câble", price: 1500 },
        ],
        // NOUVEAU: Mettre à jour la structure des utilisateurs si nécessaire
        users: JSON.parse(localStorage.getItem("itc_users_v1")) || [
          { user: "manager", pass: "admin", role: "manager" },
          { user: "tech", pass: "1234", role: "technicien" },
          { user: "client_validator", pass: "client123", role: "validator" },
        ],
      };

      const qhseTips = [
        "⚠️ **Sécurité en zone de travaux :** Balisez toujours la zone de coupure avec des cônes et des rubans pour prévenir les tiers.",
        "👷 **Port des EPI :** Le casque, les gants de protection et les chaussures de sécurité sont obligatoires sur tout site d'intervention.",
        "🔥 **Risque incendie :** Ayez toujours un extincteur portable à proximité immédiate lors des travaux de soudure.",
        "🔋 **Batteries fusionneuse :** Assurez-vous que les batteries de votre fusionneuse sont stockées à l'abri de la chaleur excessive pour éviter la surchauffe.",
        "🩺 **Premiers secours :** Vérifiez l'état de la trousse de premiers secours dans le véhicule avant chaque départ en mission.",
        "🛣️ **Sécurité routière :** Respectez les limitations de vitesse et assurez-vous de la bonne fixation du matériel sur le véhicule.",
        "🔌 **Soudure :** Ne jamais regarder directement l'arc de soudure sans protection, même brièvement, pour éviter les lésions oculaires.",
        "🧹 **Propreté du site :** Laissez toujours le site d'intervention propre et exempt de débris après la fin des travaux.",
      ];

      let currentUser = null,
        currentReportIndex = null,
        currentInvoiceIndex = null;
      let boqData = [{ item: "", qty: "" }],
        imagesData = {},
        surveillanceImages = [],
        invItems = [];
      let survData = [],
        fiberData = [];
      let charts = {};
      let mapInstance = null;
      let markersGroup = null;

      // --- CODE GENERATOR (Generalized) ---
      function getNewReportCode(type) {
        let counter =
          parseInt(localStorage.getItem("itc_report_counter") || 0) + 1;
        localStorage.setItem("itc_report_counter", counter);
        const year = new Date().getFullYear().toString().slice(2);
        const prefixMap = {
          incident: "INC",
          surveillance: "SURV",
          normalisation: "NORM",
          mise_a_dispo: "DISPO",
          otdr: "OTDR",
          survey_terrain: "SURV-T",
        };
        const prefix = prefixMap[type] || "GEN";
        return `${prefix}-${year}-${counter.toString().padStart(4, "0")}`;
      }

      // --- UTILS PERMISSIONS & NAV ---
      function toggleSidebar() {
        const sidebar = document.getElementById("app-sidebar");
        const menuBtn = document.getElementById("mobile-menu-btn");

        sidebar.classList.toggle("active");

        if (sidebar.classList.contains("active")) {
          menuBtn.innerHTML = '<i class="fas fa-times"></i>';
        } else {
          menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
        }
      }

      function checkAuth() {
        const s = localStorage.getItem("itc_session_v41");
        if (s) {
          try {
            currentUser = JSON.parse(s);
            document.getElementById("login-overlay").classList.add("hidden");
            document.getElementById("app-wrapper").classList.add("visible");
            applyPermissions();
            switchView("dashboard");
          } catch (e) {
            logout();
          }
        } else {
          document.getElementById("login-overlay").classList.remove("hidden");
        }
      }

      function login() {
        const u = document.getElementById("login-user").value.trim(),
          p = document.getElementById("login-pass").value.trim();
        const user = APP_DATA.users.find((x) => x.user === u && x.pass === p);
        if (user) {
          localStorage.setItem("itc_session_v41", JSON.stringify(user));
          currentUser = user;
          document.getElementById("login-overlay").classList.add("hidden");
          document.getElementById("app-wrapper").classList.add("visible");
          applyPermissions();
          switchView("dashboard");
        } else {
          alert("Erreur identification");
        }
      }

      function logout() {
        localStorage.removeItem("itc_session_v41");
        document.getElementById("app-wrapper").classList.remove("visible");
        document.getElementById("login-overlay").classList.remove("hidden");
        currentUser = null;
      }

      function applyPermissions() {
        if (!currentUser) return;

        // ADMIN RESTRICTIONS
        const isManager = currentUser.role === "manager";
        document
          .querySelectorAll(".restricted-admin")
          .forEach((e) => e.classList.toggle("hidden", !isManager));

        // FINANCE RESTRICTIONS
        const isFinanceUser = isManager || currentUser.role === "validator";
        document
          .querySelectorAll(".restricted-finance")
          .forEach((e) => e.classList.toggle("hidden", !isFinanceUser));

        document.getElementById("current-username").innerText =
          currentUser.user;

        // SIDEBAR RESTRICTIONS FOR VALIDATOR
        if (currentUser.role === "validator") {
          document.querySelectorAll(".nav-btn").forEach((btn) => {
            const view = btn.onclick.toString();
            // N'afficher que dashboard, history (archives) et invoices-list
            if (
              view.includes("dashboard") ||
              view.includes("invoices-list") ||
              view.includes("history")
            ) {
              btn.style.display = "block";
            } else {
              btn.style.display = "none";
            }
          });
          document.querySelector(
            "button[onclick=\"startNewReport('incident')\"]"
          ).style.display = "none";
          document.querySelector(
            "button[onclick=\"startNewReport('survey_terrain')\"]"
          ).style.display = "none";
        } else {
          // Rétablir la vue normale pour les autres rôles
          document
            .querySelectorAll(".nav-btn")
            .forEach((btn) => (btn.style.display = "block"));
          document.querySelector(
            "button[onclick=\"startNewReport('incident')\"]"
          ).style.display = "flex";
          document.querySelector(
            "button[onclick=\"startNewReport('survey_terrain')\"]"
          ).style.display = "flex";
        }
      }

      function resetApp() {
        if (confirm("Reset total ?")) {
          localStorage.clear();
          localStorage.setItem("itc_report_counter", 0);
          location.reload();
        }
      }
      function toggleFullscreenPreview() {
        document.body.classList.toggle("fullscreen-preview");
      }

      function switchView(id) {
        // FERMER LA SIDEBAR SUR MOBILE APRES LA NAVIGATION
        if (
          document.getElementById("app-sidebar").classList.contains("active")
        ) {
          toggleSidebar();
        }

        document
          .querySelectorAll("#main-container > div")
          .forEach((e) => e.classList.add("hidden"));
        document.getElementById(`view-${id}`).classList.remove("hidden");
        if (id === "dashboard") initDashboard();
        if (id === "incidents") renderIncidentsTable();
        if (id === "history") renderHistoryTable();
        if (id === "invoices-list") renderInvoicesTable();
        if (id === "map") renderMapView();
        if (id === "invoice") upInv();
        if (id === "admin-users") renderAdminUsers();
      }

      // --- ADMIN USERS FUNCTIONS (NEW) ---
      function renderAdminUsers() {
        const listBody = document.getElementById("admin-users-list");
        listBody.innerHTML = APP_DATA.users
          .map((u, index) => {
            const isCurrentUser = u.user === currentUser.user;
            const isProtected =
              u.user === "manager" || u.user === "client_validator"; // Protéger les comptes par défaut

            return `<tr class="hover:bg-slate-50 ${
              isCurrentUser ? "bg-yellow-50 font-bold" : ""
            }">
                          <td class="p-4">${u.user} ${
              isCurrentUser ? "(Vous)" : ""
            }</td>
                          <td class="p-4 uppercase text-xs">${u.role}</td>
                          <td class="p-4 text-right">
                              ${
                                isProtected || isCurrentUser
                                  ? `<span class="text-gray-400 text-xs">Protégé</span>`
                                  : `<button onclick="deleteUser(${index})" class="text-red-600 hover:text-red-800 p-1" title="Supprimer"><i class="fas fa-trash"></i></button>`
                              }
                          </td>
                      </tr>`;
          })
          .join("");
      }

      function addUser() {
        const user = document.getElementById("admin-user-id").value.trim();
        const pass = document.getElementById("admin-user-pass").value.trim();
        const role = document.getElementById("admin-user-role").value;

        if (!user || !pass) {
          alert("Veuillez remplir l'identifiant et le mot de passe.");
          return;
        }
        if (APP_DATA.users.some((u) => u.user === user)) {
          alert(`L'utilisateur '${user}' existe déjà.`);
          return;
        }

        APP_DATA.users.push({ user, pass, role });
        localStorage.setItem("itc_users_v1", JSON.stringify(APP_DATA.users));
        alert(`Utilisateur '${user}' (${role}) ajouté avec succès.`);

        // Clear inputs
        document.getElementById("admin-user-id").value = "";
        document.getElementById("admin-user-pass").value = "";

        renderAdminUsers();
      }

      function deleteUser(index) {
        const userToDelete = APP_DATA.users[index];
        if (
          userToDelete.user === currentUser.user ||
          userToDelete.user === "manager" ||
          userToDelete.user === "client_validator"
        ) {
          alert(
            "Impossible de supprimer cet utilisateur (compte protégé ou utilisateur actuel)."
          );
          return;
        }
        if (
          confirm(
            `Confirmez-vous la suppression de l'utilisateur '${userToDelete.user}'?`
          )
        ) {
          APP_DATA.users.splice(index, 1);
          localStorage.setItem("itc_users_v1", JSON.stringify(APP_DATA.users));
          renderAdminUsers();
        }
      }
      // --- END ADMIN USERS FUNCTIONS ---

      function initDashboard() {
        // Update QHSE Flash Tip
        const randomIndex = Math.floor(Math.random() * qhseTips.length);
        document.getElementById(
          "qhse-tip"
        ).innerHTML = `<i class="fas fa-lightbulb mr-2"></i> ${qhseTips[randomIndex]}`;

        document.getElementById("dash-total").innerText =
          APP_DATA.reports.length;
        const incs = APP_DATA.reports.filter(
          (r) => r.summary.type === "incident"
        );
        const trend =
          incs.filter(
            (r) => new Date(r.summary.date) > new Date(Date.now() - 2592000000)
          ).length >= 5
            ? "Hausse"
            : "Baisse";
        document.getElementById("ai-pred-val").innerHTML =
          trend === "Hausse"
            ? `<span class="trend-up"><i class="fas fa-arrow-trend-up"></i> Hausse</span>`
            : `<span class="trend-down"><i class="fas fa-arrow-trend-down"></i> Baisse</span>`;
        document.getElementById(
          "ai-trend-text"
        ).innerText = `Basé sur ${incs.length} incidents.`;
        if (charts.rec) charts.rec.destroy();
        const ctx1 = document.getElementById("recurrenceChart");
        if (ctx1)
          charts.rec = new Chart(ctx1, {
            type: "line",
            data: {
              labels: ["J", "F", "M", "A", "M", "J"],
              datasets: [
                {
                  label: "Incidents",
                  data: [2, 4, 3, 6, 4, incs.length],
                  borderColor: "#3b82f6",
                  tension: 0.4,
                  fill: true,
                  backgroundColor: "rgba(59,130,246,0.1)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
            },
          });
      }

      function startNewReport(type = "incident") {
        currentReportIndex = null;
        boqData = [{ item: "", qty: "" }];
        imagesData = {};
        surveillanceImages = [];
        survData = [{ date: "", axe: "", heure: "", obs: "" }];
        fiberData = [
          { brin: 1, lossAB: "", lossBA: "", status: "OK", comment: "" },
        ];
        document.getElementById("report-type").value = type;
        renderForm();
        switchView("editor");
      }

      function renderForm() {
        const t = document.getElementById("report-type").value;
        const c = document.getElementById("dynamic-form-fields");
        c.innerHTML = "";

        if (currentReportIndex === null) {
          const newCode = getNewReportCode(t);
          c.innerHTML += `<input type="hidden" id="inp_report_code" value="${newCode}">`;
        }

        addInp(c, "liaison", "Liaison", "text");
        c.innerHTML += `<div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Zone</label><select id="inp_zone" class="form-input font-bold" onchange="renderPreview()"><option>Abidjan</option><option>Intérieur</option></select></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Ville</label><input id="inp_ville" class="form-input" oninput="renderPreview()"></div></div>`;
        const teamOptions = [
          "ITC_TEAM_ABJIDAN_1",
          "ITC_TEAM_ABJIDAN_2",
          "ITC_TEAM_ABJIDAN_3",
          "ITC_TEAM_ABJIDAN_4",
          "ITC_TEAM_YAMOUSSOUKRO",
          "ITC_TEAM_DALOA",
          "ITC_TEAM_MAN",
        ];
        addInp(
          c,
          "intervenant",
          "Intervenant",
          "select",
          teamOptions[0],
          teamOptions
        );
        addInp(c, "liaison", "Liaison", "text");

        if (t === "incident") {
          addSection(c, "Chronologie");
          c.innerHTML += `<div class="grid grid-cols-2 gap-2 bg-slate-50 p-2 rounded mb-2 border"><div><label class="text-[10px] text-red-500 font-bold">Coupure</label><input type="datetime-local" id="inp_start" class="form-input text-xs" onchange="renderPreview()"></div><div><label class="text-[10px] text-green-500 font-bold">Rétablissement</label><input type="datetime-local" id="inp_end" class="form-input text-xs" onchange="renderPreview()"></div></div>`;
          addInp(c, "cause", "Cause", "select", "Coupure Fibre", [
            "Coupure Fibre",
            "Travaux Tiers",
            "Rongeurs",
            "Vandalisme",
          ]);
          addInp(c, "cause_detail", "Détails", "textarea");
          c.innerHTML += `<div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">PK / GPS</label><div class="flex gap-2"><input id="inp_pk_gps" class="form-input mb-0" placeholder="ex: PK12 / 5.345, -4.123" oninput="renderPreview()"><button onclick="renderPreview()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-map-marker-alt"></i> Localiser</button></div></div>`;
          addInp(c, "statut", "Statut", "select", "Terminé", [
            "Terminé",
            "Provisoire",
            "En Cours",
          ]);
          addSection(c, "Photos");
          renderPhotoEditor(c, "img_coupure", "Constat (Multi-Images)");
          renderPhotoEditor(c, "img_travaux", "Travaux (Multi-Images)");
          renderPhotoEditor(c, "img_fin", "Fin (Multi-Images)");
          addSection(c, "Matériel");
          c.innerHTML += `<div id="boq-editor" class="space-y-1"></div><button onclick="addBoqLine()" class="text-xs text-blue-600 font-bold mt-1">+ Ligne</button>`;
          renderBoqEditor();
        } else if (t === "surveillance") {
          c.innerHTML += `<div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">PK / GPS du point</label><div class="flex gap-2"><input id="inp_pk_gps" class="form-input mb-0" placeholder="ex: PK12 / 5.345, -4.123" oninput="renderPreview()"><button onclick="renderPreview()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-map-marker-alt"></i> Localiser</button></div></div>`;
          addSection(c, "Ronde de Surveillance");
          c.innerHTML += `<div id="surv-editor"></div><button onclick="addSurvLine()" class="text-xs text-blue-600 font-bold mt-1">+ Ligne Ronde</button>`;
          renderSurvEditor();
          addSection(c, "Galerie Photos (Grille)");
          c.innerHTML += `<div class="flex flex-wrap gap-2 mb-2" id="surv-thumbs"></div><button onclick="addSurveillancePhoto()" class="w-full bg-blue-100 text-blue-700 py-2 rounded text-xs font-bold">+ Ajouter Photo</button>`;
        } else if (t === "survey_terrain") {
          addSection(c, "Type de Survey");
          addInp(c, "survey_type", "Type", "select", "Création", [
            "Création",
            "Normalisation",
            "Déplacement",
          ]);
          addInp(c, "ref_associee", "Réf. Associée (Facultatif)", "text");
          addSection(c, "Constat et Observations");
          addInp(c, "constat_terrain", "Constat Terrain", "textarea");
          addInp(c, "observation", "Observation", "textarea");
          addSection(c, "Image Terrain");
          renderPhotoEditor(c, "img_terrain", "Images Site (Multi-Images)");
          addSection(c, "Signatures pour Rapport");
          addInp(c, "sign_moov_name", "Représentant Client MOOV", "text");
          addInp(
            c,
            "sign_itc_name",
            "Prestataire ITC",
            "text",
            document.getElementById("inp_intervenant").value
          );
        } else if (t === "normalisation") {
          addInp(c, "ref_incident", "Réf. Incident Origine", "text");
          c.innerHTML += `<div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">PK / GPS du site</label><div class="flex gap-2"><input id="inp_pk_gps" class="form-input mb-0" placeholder="ex: PK12 / 5.345, -4.123" oninput="renderPreview()"><button onclick="renderPreview()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-map-marker-alt"></i> Localiser</button></div></div>`;
          addSection(c, "Comparatif");
          renderPhotoEditor(
            c,
            "img_avant",
            "Avant (Provisoire) (Multi-Images)"
          );
          renderPhotoEditor(c, "img_apres", "Après (Définitif) (Multi-Images)");
          addSection(c, "Matériel");
          c.innerHTML += `<div id="boq-editor" class="space-y-1"></div><button onclick="addBoqLine()" class="text-xs text-blue-600 font-bold mt-1">+ Ligne</button>`;
          renderBoqEditor();
        } else if (t === "mise_a_dispo" || t === "otdr") {
          addSection(c, "Configuration");
          addInp(c, "site_a", "Site A", "text");
          addInp(c, "site_b", "Site B", "text");
          addSection(c, "Photos Extrémités");
          renderPhotoEditor(c, "img_site_a", "Photo Site A (Multi-Images)");
          renderPhotoEditor(c, "img_site_b", "Photo Site B (Multi-Images)");
          addSection(c, "Tableau des Mesures");
          c.innerHTML += `<div id="fiber-editor"></div><button onclick="addFiberLine()" class="text-xs text-blue-600 font-bold mt-1">+ Ligne</button>`;
          renderFiberEditor();
        }

        const conclusionTitle =
          t === "survey_terrain"
            ? "CONCLUSION ET RECOMMANDATION"
            : "CONCLUSION";
        addSection(c, conclusionTitle);
        addInp(c, "constat", "Constat Principal", "textarea");

        if (t !== "survey_terrain") {
          addInp(c, "actions", "Actions / Recommandations", "textarea");
        }

        renderPreview();
        // Dans la fonction renderForm(), ajoutez ces lignes :
        addSection(c, "Localisation");
        const locDiv = document.createElement("div");
        locDiv.className = "flex gap-2 mb-4";
        locDiv.innerHTML = `
          <input type="text" id="inp_gps" class="form-input flex-1" placeholder="Coordonnées GPS (Lat, Long)" readonly>
          <button onclick="getLocation()" type="button" class="bg-green-600 text-white px-4 rounded-lg hover:bg-green-500 transition">
              <i class="fas fa-map-marker-alt"></i>
          </button>
      `;
        c.appendChild(locDiv);
        addInp(c, "adresse_auto", "Adresse détectée", "text", "");

        // À ajouter juste avant la fin de renderForm()
        document
          .querySelectorAll(
            "#dynamic-form-fields input, #dynamic-form-fields textarea, #dynamic-form-fields select"
          )
          .forEach((input) => {
            input.addEventListener("input", saveDraft);
          });
      }

      function getLocation() {
        const btn = event.currentTarget;
        const originalContent = btn.innerHTML;
        const gpsInput = document.getElementById("inp_gps");
        const addrInput = document.getElementById("inp_adresse_auto");

        if (!navigator.geolocation) {
          alert("La géolocalisation n'est pas supportée par votre navigateur.");
          return;
        }

        // Effet visuel de chargement
        btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);

            // 1. Remplir le champ GPS
            gpsInput.value = `${lat}, ${lon}`;

            // 2. Récupérer l'adresse (Reverse Geocoding gratuit via Nominatim)
            fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
            )
              .then((response) => response.json())
              .then((data) => {
                if (data.display_name) {
                  addrInput.value = data.display_name;
                }
                renderPreview(); // Mettre à jour l'aperçu PDF
              })
              .catch((err) => console.error("Erreur adresse:", err))
              .finally(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                renderPreview();
              });
          },
          (error) => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            let msg = "Erreur de localisation.";
            if (error.code === 1)
              msg =
                "Veuillez autoriser l'accès à la position dans votre navigateur.";
            alert(msg);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      function renderPreview() {
        const container = document.getElementById("report-pages-container");
        container.innerHTML = "";

        const t = document.getElementById("report-type").value;
        const val = (id) => document.getElementById(`inp_${id}`)?.value || "";

        const code = val("report_code");
        const codeHtml = code
          ? `<p class="text-lg font-black text-slate-800 mt-2">Réf: <span class="text-pink-600">${code}</span></p>`
          : "";

        let statusHtml = "";
        const stat = val("statut");
        if (stat) {
          const isTermine = stat === "Terminé";
          const color = isTermine
            ? "text-green-600 border-green-600 bg-green-50"
            : "text-orange-600 border-orange-600 bg-orange-50";
          statusHtml = `<div class="mt-4"><span class="text-xl font-black border-4 px-6 py-2 rounded-full uppercase tracking-widest ${color}">${stat}</span></div>`;
        }

        let slaHtml = "";
        const startStr = val("start");
        const endStr = val("end");
        const zone = val("zone");

        if (t === "incident" && startStr && endStr) {
          const start = new Date(startStr);
          const end = new Date(endStr);
          const diffMs = end - start;

          if (diffMs > 0) {
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffMins = Math.floor((diffMs % 3600000) / 60000);
            const durationText = `${diffHrs}h ${diffMins
              .toString()
              .padStart(2, "0")}`;

            const limit = zone === "Abidjan" ? 4 : 6;
            const isOk = diffMs / 3600000 <= limit;

            const colorClass = isOk
              ? "text-green-600 border-green-600"
              : "text-red-600 border-red-600";
            const label = isOk ? "SLA RESPECTÉ" : "HORS DÉLAI";

            slaHtml = `
                          <div style="border: 4px solid; padding: 10px 20px; border-radius: 8px; font-weight: 900; text-transform: uppercase; font-size: 1.2rem; transform: rotate(-8deg); opacity: 0.9; margin-top: 20px; text-align:center;" class="${colorClass}">
                              <div style="font-size:0.8rem; letter-spacing:1px;">DURÉE: ${durationText}</div>
                              <div>${label}</div>
                          </div>`;
          }
        }

        // --- PAGE DE GARDE ---
        const coverDiv = document.createElement("div");
        coverDiv.className = "a4-page";
        coverDiv.innerHTML = `
                      <img src="LOGO ITC.png" class="watermark" onerror="this.style.display='none'">
                      <div class="header-logos-container"><img src="LOGO ITC.png" class="header-logo-img"><img src="logo MOOV.png" class="header-logo-img"></div>
                      <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:20px; margin-top:50px;">
                          <h1 class="cover-title">${t
                            .replace(/_/g, " ")
                            .toUpperCase()}</h1>
                          <div class="cover-liaison">${
                            val("liaison") || "..."
                          }</div>
                          <div style="text-align:center; margin-top:10px;">
                              ${codeHtml}
                              <p class="text-lg"><strong>Date:</strong> ${val(
                                "date_rapport"
                              )}</p>
                              <p class="text-lg"><strong>Intervenant:</strong> ${val(
                                "intervenant"
                              )}</p>
                              <p class="text-lg"><strong>Zone:</strong> ${val(
                                "zone"
                              )} - ${val("ville")}</p>
                              ${
                                (t === "incident" || t === "survey_terrain") &&
                                (val("cause") || val("survey_type"))
                                  ? `<br><div class="text-xl font-bold ${
                                      t === "incident"
                                        ? "text-red-500 border-red-200"
                                        : "text-pink-600 border-pink-200"
                                    } uppercase border-2 p-2 rounded">${
                                      t === "incident"
                                        ? val("cause")
                                        : val("survey_type")
                                    }</div>`
                                  : ""
                              }
                          </div>
                          ${statusHtml}
                          ${slaHtml}
                      </div>
                      <div class="page-number">Page 1</div>
                  `;
        container.appendChild(coverDiv);

        // --- PAGINATION BLOCKS ---
        let contentBlocks = [];

        contentBlocks.push({
          h: 50,
          html: `<div class="flex justify-between items-center border-b-2 border-slate-200 pb-2 mb-4"><span class="font-bold text-slate-400 text-xs tracking-wider">DÉTAILS OPÉRATIONNELS</span><span class="text-xs font-bold text-slate-500">${val(
            "liaison"
          )}</span></div>`,
        });

        if (
          t === "incident" ||
          t === "surveillance" ||
          t === "normalisation" ||
          t === "otdr" ||
          t === "mise_a_dispo" ||
          t === "survey_terrain"
        ) {
          let gpsBlock = "";
          const gpsValue = val("pk_gps");
          const gpsMatch = gpsValue
            ? gpsValue.match(/(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/)
            : null;

          if (gpsMatch) {
            const [_, lat, lng] = gpsMatch;
            gpsBlock = `<div class="report-block map-box"><div class="map-visual"><i class="fas fa-map-pin"></i></div><div class="map-details"><div class="text-[10px] font-bold text-slate-400">LOCALISATION</div><div class="map-coords">${lat}, ${lng}</div></div></div>`;
          }

          if (t === "incident") {
            contentBlocks.push({
              h: 120,
              html: `<div class="report-block"><div class="section-header">1. CHRONOLOGIE ET DÉTAILS</div><table class="data-table"><tr><th>Début</th><td>${val(
                "start"
              )?.replace("T", " ")}</td><th>Cause</th><td>${val(
                "cause"
              )}</td></tr><tr><th>Fin</th><td>${val("end")?.replace(
                "T",
                " "
              )}</td><th>GPS</th><td>${val(
                "pk_gps"
              )}</td></tr></table><div class="p-2 bg-slate-50 border-l-4 border-slate-400 text-xs italic mt-2">${val(
                "cause_detail"
              )}</div></div>`,
            });
            if (gpsBlock) contentBlocks.push({ h: 120, html: gpsBlock });
            contentBlocks.push({
              h: 250,
              html: `<div class="report-block"><div class="section-header">2. PHOTOS</div>${getPhotoHtml(
                "img_coupure",
                "CONSTAT"
              )}</div>`,
            });
            contentBlocks.push({
              h: 250,
              html: `<div class="report-block">${getPhotoHtml(
                "img_travaux",
                "TRAVAUX"
              )}</div>`,
            });

            let finHtml = `<div class="report-block">${getPhotoHtml(
              "img_fin",
              "FIN / PROPRE"
            )}</div>`;
            finHtml += `<div class="report-block">${getBoqTableHtml()}</div>`;
            finHtml += `<div class="report-block"><div class="section-header">CONCLUSION</div><div class="border rounded p-2 bg-slate-50 mb-2"><strong class="text-xs uppercase">Constat:</strong><br>${val(
              "constat"
            )}</div><div class="border rounded p-2 bg-slate-50"><strong class="text-xs uppercase">Actions:</strong><br>${val(
              "actions"
            )}</div></div>`;
            contentBlocks.push({
              h: 600,
              html: finHtml,
              forceBreakIfTight: true,
            });
          } else if (t === "survey_terrain") {
            contentBlocks.push({
              h: 150,
              html: `<div class="report-block"><div class="section-header">1. CONTEXTE ET CONSTAT TERRAIN</div><table class="data-table"><tr><th class="w-1/3">Type de Survey</th><td>${val(
                "survey_type"
              )}</td></tr><tr><th>Réf. Associée</th><td>${val(
                "ref_associee"
              )}</td></tr></table><div class="p-2 bg-slate-50 border-l-4 border-slate-400 text-xs italic mt-2"><strong class="uppercase">Constat Terrain:</strong> ${val(
                "constat_terrain"
              )}</div></div>`,
            });
            contentBlocks.push({
              h: 100,
              html: `<div class="report-block"><div class="section-header">2. OBSERVATION</div><div class="border rounded p-2 bg-slate-50"><strong class="text-xs uppercase">Observation:</strong><br>${val(
                "observation"
              )}</div></div>`,
            });

            contentBlocks.push({
              h: 250,
              html: `<div class="report-block"><div class="section-header">3. IMAGE TERRAIN</div>${getPhotoHtml(
                "img_terrain",
                "IMAGES SITE"
              )}</div>`,
            });

            let finHtml = `<div class="report-block"><div class="section-header">4. CONCLUSION ET SIGNATURES</div><div class="border rounded p-2 bg-slate-50 mb-4"><strong class="text-xs uppercase">Conclusion & Recommandation:</strong><br>${val(
              "constat"
            )}</div><div class="flex justify-between pt-4"><div class="w-5/12 text-center"><p class="text-xs font-bold text-slate-700 mb-2">CLIENT MOOV</p><div class="h-16 border-b border-gray-400 mb-2 bg-slate-100/50 flex items-center justify-center text-xs italic text-gray-500">Signature Digitale</div><p class="text-xs font-bold">${
              val("sign_moov_name") || "Signature requise"
            }</p></div><div class="w-5/12 text-center"><p class="text-xs font-bold text-slate-700 mb-2">PRESTATAIRE ITC</p><div class="h-16 border-b border-gray-400 mb-2 bg-slate-100/50 flex items-center justify-center text-xs italic text-gray-500">Signature Digitale</div><p class="text-xs font-bold">${
              val("sign_itc_name") || "Signature requise"
            }</p></div></div></div>`;
            contentBlocks.push({
              h: 400,
              html: finHtml,
              forceBreakIfTight: true,
            });
          } else if (t === "normalisation") {
            contentBlocks.push({
              h: 120,
              html: `<div class="report-block"><div class="section-header">1. INFORMATIONS</div><table class="data-table"><tr><th>Incident Source</th><td>${val(
                "ref_incident"
              )}</td><th>GPS</th><td>${val("pk_gps")}</td></tr></table></div>`,
            });
            if (gpsBlock) contentBlocks.push({ h: 120, html: gpsBlock });
            contentBlocks.push({
              h: 250,
              html: `<div class="report-block"><div class="section-header">2. PHOTOS COMPARATIF</div>${getPhotoHtml(
                "img_avant",
                "AVANT (PROVISOIRE)"
              )}</div>`,
            });
            contentBlocks.push({
              h: 250,
              html: `<div class="report-block">${getPhotoHtml(
                "img_apres",
                "APRÈS (NORMALISÉ)"
              )}</div>`,
            });
            let finHtml = `<div class="report-block">${getBoqTableHtml()}</div>`;
            finHtml += `<div class="report-block"><div class="section-header">CONCLUSION</div><div class="border rounded p-2 bg-slate-50 mb-2"><strong class="text-xs uppercase">Constat:</strong><br>${val(
              "constat"
            )}</div><div class="border rounded p-2 bg-slate-50"><strong class="text-xs uppercase">Actions:</strong><br>${val(
              "actions"
            )}</div></div>`;
            contentBlocks.push({
              h: 400,
              html: finHtml,
              forceBreakIfTight: true,
            });
          } else if (t === "surveillance") {
            contentBlocks.push({
              h: 120,
              html: `<div class="report-block"><div class="section-header">1. ZONE ET POINT</div><table class="data-table"><tr><th>Zone</th><td>${val(
                "zone"
              )} - ${val("ville")}</td><th>GPS</th><td>${val(
                "pk_gps"
              )}</td></tr></table></div>`,
            });
            if (gpsBlock) contentBlocks.push({ h: 120, html: gpsBlock });
            // Simpler output for surveillance table
            let survRows = survData
              .map(
                (s) =>
                  `<tr><td class="text-center">${s.date}</td><td class="pl-2">${s.axe}</td><td class="text-center">${s.heure}</td><td class="pl-2">${s.obs}</td></tr>`
              )
              .join("");
            let survTable = `<div class="report-block"><div class="section-header">RONDE DE SURVEILLANCE</div><table class="data-table"><thead><tr><th class="w-20">Date</th><th class="w-1/4">Axe</th><th class="w-16">Heure</th><th>Observation</th></tr></thead><tbody>${survRows}</tbody></table></div>`;
            contentBlocks.push({
              h: 100 + survData.length * 20,
              html: survTable,
            });
            contentBlocks.push({
              h: 250,
              html: `<div class="report-block"><div class="section-header">GALERIE PHOTOS</div><div class="photo-grid-3">${surveillanceImages
                .map(
                  (img) =>
                    `<div class="photo-container-small"><img src="${img}"></div>`
                )
                .join("")}</div></div>`,
            });
          } else if (t === "mise_a_dispo" || t === "otdr") {
            contentBlocks.push({
              h: 60,
              html: `<div class="report-block bg-slate-100 p-2 text-xs font-bold flex justify-between rounded mb-2"><span>Site A: ${val(
                "site_a"
              )}</span><span>Site B: ${val("site_b")}</span></div>`,
            });
            contentBlocks.push({
              h: 220,
              html: `<div class="report-block photo-grid">${getRawPhotoHtml(
                "img_site_a",
                "SITE A"
              )}${getRawPhotoHtml("img_site_b", "SITE B")}</div>`,
            });
            let rows = fiberData
              .map(
                (f) =>
                  `<tr><td class="text-center font-bold">${
                    f.brin
                  }</td><td class="text-center">${
                    f.lossAB
                  }</td><td class="text-center">${
                    f.lossBA
                  }</td><td class="text-center font-bold ${
                    f.status === "HS"
                      ? "text-red-600"
                      : f.status === "OK"
                      ? "text-green-600"
                      : ""
                  }">${f.status}</td><td class="italic pl-2 text-xs">${
                    f.comment
                  }</td></tr>`
              )
              .join("");
            let tableHeight = 60 + fiberData.length * 25;
            contentBlocks.push({
              h: tableHeight,
              html: `<div class="report-block"><div class="section-header">MESURES</div><table class="data-table"><thead><tr><th class="w-10">Brin</th><th>A->B</th><th>B->A</th><th>Statut</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table></div>`,
            });
            contentBlocks.push({
              h: 150,
              html: `<div class="report-block mt-4"><div class="section-header">CONCLUSION</div><div class="border rounded p-2 bg-slate-50 text-xs">${val(
                "constat"
              )}</div></div>`,
              forceBreakIfTight: true,
            });
          }
        }

        let pageNum = 2;
        let currentPageDiv = createNewPageDiv(pageNum);
        let currentHeight = 0;
        const MAX_HEIGHT = 980;

        contentBlocks.forEach((block) => {
          let shouldBreak = currentHeight + block.h > MAX_HEIGHT;
          if (block.forceBreakIfTight && currentHeight > 500) {
            shouldBreak = true;
          }
          if (shouldBreak) {
            container.appendChild(currentPageDiv);
            pageNum++;
            currentPageDiv = createNewPageDiv(pageNum);
            currentHeight = 0;
            currentPageDiv.querySelector(
              ".report-content-safe-zone"
            ).innerHTML += `<div class="text-[10px] text-slate-300 border-b mb-4">Suite: ${val(
              "liaison"
            )}</div>`;
            currentHeight += 30;
          }
          currentPageDiv.querySelector(".report-content-safe-zone").innerHTML +=
            block.html;
          currentHeight += block.h;
        });
        container.appendChild(currentPageDiv);

        // Sauvegarde automatique si c'est un nouveau rapport (pour éviter de corrompre les archives)
        if (currentReportIndex === null) {
          saveDraft();
        }
      }

      function createNewPageDiv(num) {
        const div = document.createElement("div");
        div.className = "a4-page";
        div.innerHTML = `
                      <img src="LOGO ITC.png" class="watermark" onerror="this.style.display='none'">
                      <div class="report-content-safe-zone"></div>
                      <div class="page-number">Page ${num}</div>
                  `;
        return div;
      }

      // --- CRUD FUNCTIONS ---
      function deleteReport(index) {
        const report = APP_DATA.reports[index];
        if (
          confirm(
            `Confirmez-vous la suppression du rapport ${report.summary.liaison} (${report.summary.type})? Cette action est irréversible.`
          )
        ) {
          APP_DATA.reports.splice(index, 1);
          localStorage.setItem(
            "itc_reports_v34",
            JSON.stringify(APP_DATA.reports)
          );
          const currentViewId = document.querySelector(
            "#main-container > div:not(.hidden)"
          ).id;
          const currentView = currentViewId.replace("view-", "");
          switchView(currentView);
        }
      }

      function jumpToGPS(index) {
        const report = APP_DATA.reports[index];
        const gps = report.data.inputs.inp_pk_gps;
        const match = gps ? gps.match(/(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/) : null;

        if (match) {
          const lat = parseFloat(match[1]);
          const lng = parseFloat(match[2]);

          switchView("map");

          setTimeout(() => {
            if (mapInstance) {
              mapInstance.setView([lat, lng], 15);
              markersGroup.eachLayer(function (layer) {
                if (
                  layer instanceof L.Marker &&
                  layer.getLatLng().lat === lat &&
                  layer.getLatLng().lng === lng
                ) {
                  layer.openPopup();
                }
              });
            }
          }, 300);
        } else {
          alert("Coordonnées GPS non disponibles pour ce rapport.");
        }
      }

      function exportCSV() {
        // 1. Filtrer uniquement les rapports de type 'incident'
        const incidents = APP_DATA.reports.filter(
          (r) => r.summary.type === "incident"
        );

        if (incidents.length === 0) {
          alert("Aucun incident à exporter.");
          return;
        }

        // 2. Définir les en-têtes du fichier CSV
        let csvContent = "Date;Code;Liaison;Intervenant;Statut;Cause;Details\n";

        // 3. Parcourir les incidents pour créer les lignes
        incidents.forEach((r) => {
          const date = r.summary.date || "";
          const code = r.data.inputs.inp_report_code || "N/A";
          const liaison = (r.summary.liaison || "").replace(/;/g, ","); // Éviter les conflits de séparateur
          const tech = (r.summary.intervenant || "").replace(/;/g, ",");
          const statut = r.data.inputs.inp_statut || "-";
          const cause = (r.data.inputs.inp_cause || "-").replace(/;/g, ",");
          const details = (r.data.inputs.inp_cause_detail || "")
            .replace(/;/g, ",")
            .replace(/\n/g, " ");

          csvContent += `${date};${code};${liaison};${tech};${statut};${cause};${details}\n`;
        });

        // 4. Création du fichier et téléchargement
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `EXPORT_INCIDENTS_ITC_${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // --- TABLES RENDERING (MODIFIED FOR ICONS, CODE, INTERVENANT) ---
      function getReportIcon(type) {
        const iconMap = {
          incident: "fas fa-tools",
          normalisation: "fas fa-check-circle",
          surveillance: "fas fa-flag",
          mise_a_dispo: "fas fa-handshake",
          otdr: "fas fa-wave-square",
          survey_terrain: "fas fa-search-location",
        };
        return iconMap[type] || "fas fa-file-alt";
      }

      function renderIncidentsTable() {
        document.getElementById("incidents-list-body").innerHTML =
          APP_DATA.reports
            .filter((r) => r.summary.type === "incident")
            .reverse()
            .map((r) => {
              const globalIndex = APP_DATA.reports.indexOf(r);
              const hasGps =
                r.data.inputs.inp_pk_gps &&
                r.data.inputs.inp_pk_gps.match(
                  /(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/
                );
              const code = r.data.inputs.inp_report_code || "N/A";
              const intervenant = r.summary.intervenant || "";

              return `<tr class="hover:bg-slate-50">
                          <td class="px-6 py-4">${r.summary.date}</td>
                          <td class="px-6 py-4 font-bold">${
                            r.summary.liaison
                          }</td>
                          <td class="px-6 py-4 text-xs">
                              <span class="font-bold text-pink-600">${code}</span><br>
                              <span class="text-slate-500">${intervenant}</span>
                          </td>
                          <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${
                            r.data.inputs.inp_statut === "Terminé"
                              ? "bg-green-100 text-green-700"
                              : "bg-orange-100 text-orange-700"
                          }">${r.data.inputs.inp_statut || "-"}</span></td>
                          <td class="px-6 py-4 text-right">
                              <div class="flex gap-2 justify-end">
                                  <button onclick="loadReport(${globalIndex})" class="text-blue-600 hover:text-blue-800 p-1" title="Consulter/Modifier"><i class="fas fa-edit"></i></button>
                                  <button onclick="jumpToGPS(${globalIndex})" class="p-1 ${
                hasGps
                  ? "text-orange-600 hover:text-orange-800"
                  : "text-gray-400 cursor-not-allowed"
              }" ${
                hasGps ? "" : "disabled"
              } title="Afficher sur Carte"><i class="fas fa-map-marker-alt"></i></button>
                                  <button onclick="deleteReport(${globalIndex})" class="text-red-600 hover:text-red-800 p-1" title="Supprimer"><i class="fas fa-trash"></i></button>
                              </div>
                          </td>
                      </tr>`;
            })
            .join("");
      }

      function renderHistoryTable() {
        document.getElementById("full-history-body").innerHTML =
          APP_DATA.reports
            .slice()
            .reverse()
            .map((r) => {
              const globalIndex = APP_DATA.reports.indexOf(r);
              const code = r.data.inputs.inp_report_code || "N/A";
              const type = r.summary.type;

              return `<tr class="hover:bg-slate-50 border-b">
                          <td class="p-4"><i class="${getReportIcon(
                            type
                          )} text-pink-600 mr-2"></i>${r.summary.date}</td>
                          <td class="p-4 uppercase text-[10px] font-bold">${type.replace(
                            /_/g,
                            " "
                          )}</td>
                          <td class="p-4 text-xs">
                              <span class="font-bold text-pink-600">${code}</span><br>
                              <span class="text-slate-500">${
                                r.summary.intervenant
                              }</span>
                          </td>
                          <td class="p-4 text-right">
                              <div class="flex gap-2 justify-end">
                                  <button onclick="printDirectlyFromArchive(${globalIndex})" class="bg-slate-800 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-slate-700">
                                      <i class="fas fa-print mr-1"></i> PDF
                                  </button>

                                  <button onclick="loadReport(${globalIndex})" class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Modifier">
                                      <i class="fas fa-edit"></i>
                                  </button>

                                  <button onclick="deleteReport(${globalIndex})" class="text-red-600 hover:bg-red-50 p-2 rounded">
                                      <i class="fas fa-trash"></i>
                                  </button>
                              </div>
                          </td>
                      </tr>`;
            })
            .join("");
      }

      // Nouvelle fonction pour imprimer sans ouvrir l'éditeur
      async function printDirectlyFromArchive(index) {
        // 1. Charger silencieusement les données dans l'aperçu
        loadReport(index);

        // 2. Attendre un court instant que le rendu HTML se fasse
        setTimeout(() => {
          const r = APP_DATA.reports[index];
          const type = r.summary.type;
          const code = r.data.inputs.inp_report_code;

          // 3. Appeler votre fonction PDF existante
          generatePDF(type, code);
        }, 500);
      }

      // --- 1. PROFORMA UTILS - AMOUNT IN WORDS ---
      function numberToFrenchWords(n) {
        const units = [
          "",
          "un",
          "deux",
          "trois",
          "quatre",
          "cinq",
          "six",
          "sept",
          "huit",
          "neuf",
        ];
        const teens = [
          "dix",
          "onze",
          "douze",
          "treize",
          "quatorze",
          "quinze",
          "seize",
          "dix-sept",
          "dix-huit",
          "dix-neuf",
        ];
        const tens = [
          "",
          "",
          "vingt",
          "trente",
          "quarante",
          "cinquante",
          "soixante",
          "soixante-dix",
          "quatre-vingt",
          "quatre-vingt-dix",
        ];

        function convertHundreds(num) {
          let s = "";
          const h = Math.floor(num / 100);
          const r = num % 100;

          if (h > 0) {
            s += h === 1 ? "cent" : units[h] + " cents";
            if (r > 0) s += " ";
            if (h > 1 && r === 0) s += "s";
          }

          if (r > 0) {
            if (r < 10) s += units[r];
            else if (r < 20) s += teens[r - 10];
            else {
              const t = Math.floor(r / 10);
              const u = r % 10;
              s += tens[t];
              if (t === 7 || t === 9) {
                const temp = r - (t === 7 ? 60 : 80);
                s += (temp === 10 ? " " : "-") + teens[temp - 10];
              } else {
                if (u === 1 && t !== 8) s += " et un";
                else if (u > 0) s += "-" + units[u];
              }
              if (t === 8 && u === 0) s += "s";
            }
          }
          return s.trim();
        }

        if (n === 0) return "zéro";
        let s = "";
        let num = Math.floor(n);

        const m = Math.floor(num / 1000000);
        num %= 1000000;
        const t = Math.floor(num / 1000);
        num %= 1000;
        const h = num;

        if (m > 0) {
          s += m === 1 ? "un million " : convertHundreds(m) + " millions ";
        }
        if (t > 0) {
          s += t === 1 ? "mille " : convertHundreds(t) + " mille ";
        }
        if (h > 0) {
          s += convertHundreds(h);
        }

        return s.trim().replace(/\s{2,}/g, " ");
      }

      // CORRECTION : Utilisation de async pour permettre l'attente du rendu de chaque page
      async function generatePDF(type, liaisonName) {
        const { jsPDF } = window.jspdf;
        // On cible précisément les pages A4 générées dans l'aperçu
        const pages = document.querySelectorAll(
          "#report-pages-container .a4-page"
        );
        const btn = document.getElementById("btn-pdf-editor");

        if (pages.length === 0) {
          alert("L'aperçu est vide. Veuillez remplir le formulaire.");
          return;
        }

        const actualLiaison =
          liaisonName ||
          document.getElementById("inp_liaison")?.value ||
          "Rapport";
        const cleanLiaison = actualLiaison
          .trim()
          .replace(/[/\\?%*:|"<>]/g, "-");

        // UI : Feedback visuel
        btn.disabled = true;
        const originalBtnText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i>...';

        const pdf = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4",
          compress: true,
        });

        try {
          // Boucle sur chaque page de l'aperçu pour les capturer une par une
          for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: "#ffffff",
            });

            const imgData = canvas.toDataURL("image/jpeg", 0.95);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            if (i > 0) pdf.addPage();
            pdf.addImage(
              imgData,
              "JPEG",
              0,
              0,
              pdfWidth,
              pdfHeight,
              undefined,
              "FAST"
            );
          }

          pdf.save(`${type.toUpperCase()}_${cleanLiaison}.pdf`);
        } catch (err) {
          console.error("Erreur PDF:", err);
          alert("Erreur lors de la génération du PDF.");
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalBtnText;
        }
      }
      // --- INVOICE FUNCTIONS ---
      function startNewInvoice() {
        currentInvoiceIndex = null;
        invItems = [
          {
            type: "Prestation",
            desc: "Déplacement et intervention",
            qty: 1,
            price: 0,
          },
        ];

        document.getElementById("inv-sign-client-name").value = "";
        document.getElementById("inv-sign-client-func").value = "";
        document.getElementById("inv-sign-itc-name").value = "Jean DUPONT";
        document.getElementById("inv-sign-itc-func").value =
          "Manager Opérationnel";

        switchView("invoice");
        upInv();
      }

      function switchToInvoiceFromReport() {
        startNewInvoice();
        const liaison = document.getElementById("inp_liaison").value;
        const code = document.getElementById("inp_report_code")?.value;

        let ref = liaison;
        if (code) {
          ref = `PROFORMA [${code}] - ${ref}`;
        }

        document.getElementById("inv-ref").value = ref;
        upInv();
      }

      function addInvItem(type) {
        invItems.push({ type: type, desc: "", qty: 1, price: 0 });
        upInv();
      }

      function upInv() {
        document.getElementById("inv-items-editor").innerHTML = invItems
          .map(
            (x, i) => `
                      <div class="flex gap-2 items-center bg-white p-1 rounded shadow-sm border ${
                        x.type === "Fourniture"
                          ? "border-blue-300"
                          : "border-purple-300"
                      }">
                          <span class="w-20 text-center text-xs font-bold ${
                            x.type === "Fourniture"
                              ? "text-blue-700"
                              : "text-purple-700"
                          }">${x.type.toUpperCase().substring(0, 4)}.</span>
                          <input class="form-input flex-1 mb-0 text-xs h-8" list="price-list-options" value="${
                            x.desc
                          }" onchange="upItem(${i},'desc',this.value)" placeholder="Description Item">
                          <input class="form-input w-12 mb-0 text-center text-xs h-8" value="${
                            x.qty
                          }" onchange="upItem(${i},'qty',this.value)" placeholder="Qté">
                          <input class="form-input w-20 mb-0 text-right text-xs h-8" value="${
                            x.price
                          }" onchange="upItem(${i},'price',this.value)" placeholder="P.U.">
                          <button onclick="removeItem(${i})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash-alt"></i></button>
                      </div>
                  `
          )
          .join("");

        let totalFourniture = 0;
        let totalPrestation = 0;

        const fournitureItems = invItems.filter((x) => x.type === "Fourniture");
        const prestationItems = invItems.filter((x) => x.type === "Prestation");

        fournitureItems.forEach((x) => {
          totalFourniture += x.qty * x.price;
        });
        prestationItems.forEach((x) => {
          totalPrestation += x.qty * x.price;
        });

        let totalHT = totalFourniture + totalPrestation;

        let rowsHTML = "";

        if (fournitureItems.length > 0) {
          rowsHTML += `<tr class="bg-blue-50/50"><td colspan="4" class="py-1 pl-2 font-black text-blue-800 text-xs">FOURNITURES</td></tr>`;
          fournitureItems.forEach((x) => {
            const t = x.qty * x.price;
            rowsHTML += `<tr>
                              <td class="pl-2 py-1 border-b border-slate-100">${
                                x.desc
                              }</td>
                              <td class="text-center">${x.qty}</td>
                              <td class="text-right">${x.price.toLocaleString()}</td>
                              <td class="text-right pr-2">${t.toLocaleString()}</td>
                          </tr>`;
          });
          rowsHTML += `<tr class="bg-blue-100/70 border-b-2 border-blue-400"><td colspan="3" class="py-1 pl-2 font-bold text-xs text-right">Sous-Total Fourniture</td><td class="text-right pr-2 font-black text-xs">${totalFourniture.toLocaleString()}</td></tr>`;
        }

        if (prestationItems.length > 0) {
          rowsHTML += `<tr class="bg-purple-50/50"><td colspan="4" class="py-1 pl-2 font-black text-purple-800 text-xs">PRESTATIONS</td></tr>`;
          prestationItems.forEach((x) => {
            const t = x.qty * x.price;
            rowsHTML += `<tr>
                              <td class="pl-2 py-1 border-b border-slate-100">${
                                x.desc
                              }</td>
                              <td class="text-center">${x.qty}</td>
                              <td class="text-right">${x.price.toLocaleString()}</td>
                              <td class="text-right pr-2">${t.toLocaleString()}</td>
                          </tr>`;
          });
          rowsHTML += `<tr class="bg-purple-100/70 border-b-2 border-purple-400"><td colspan="3" class="py-1 pl-2 font-bold text-xs text-right">Sous-Total Prestation</td><td class="text-right pr-2 font-black text-xs">${totalPrestation.toLocaleString()}</td></tr>`;
        }

        document.getElementById("prev-inv-items").innerHTML = rowsHTML;

        document.getElementById("prev-subtotal-fourniture").innerText =
          totalFourniture.toLocaleString() + " FCFA";
        document.getElementById("prev-subtotal-prestation").innerText =
          totalPrestation.toLocaleString() + " FCFA";
        document.getElementById("prev-total-ht").innerText =
          totalHT.toLocaleString() + " FCFA";
        document.getElementById("prev-total-ttc").innerText =
          totalHT.toLocaleString() + " FCFA";

        document.getElementById("prev-total-words").innerText =
          numberToFrenchWords(totalHT) + " francs CFA";

        document.getElementById("prev-inv-num").innerText =
          document.getElementById("inv-num").value;
        document.getElementById("prev-inv-client").innerText =
          document.getElementById("inv-client").value;
        document.getElementById("prev-inv-ref").innerText =
          document.getElementById("inv-ref").value;

        document.getElementById("prev-sign-client-name").innerText =
          document.getElementById("inv-sign-client-name").value ||
          "NOM & PRÉNOM";
        document.getElementById("prev-sign-client-func").innerText =
          document.getElementById("inv-sign-client-func").value || "Fonction";
        document.getElementById("prev-sign-itc-name").innerText =
          document.getElementById("inv-sign-itc-name").value || "NOM & PRÉNOM";
        document.getElementById("prev-sign-itc-func").innerText =
          document.getElementById("inv-sign-itc-func").value || "Fonction";

        const s = document.getElementById("inv-status").value;
        document.getElementById("prev-inv-status").innerText = s;
        document.getElementById(
          "prev-inv-status"
        ).className = `px-4 py-1 border-2 rounded font-bold uppercase text-sm transform -rotate-6 ${
          s === "Validé"
            ? "border-green-600 text-green-600"
            : s === "Proformé"
            ? "border-orange-600 text-orange-600"
            : s === "Annulé"
            ? "border-red-500 text-red-500"
            : "border-slate-800 text-slate-800"
        }`;

        const btnApprove = document.getElementById("btn-approve-invoice");
        const isApprovedOrCancelled = s === "Validé" || s === "Annulé";

        if (
          currentUser &&
          (currentUser.role === "manager" ||
            currentUser.role === "validator") &&
          s === "Proformé"
        ) {
          btnApprove.classList.remove("hidden");
        } else {
          btnApprove.classList.add("hidden");
        }

        const isReadonly =
          isApprovedOrCancelled ||
          (currentUser.role === "validator" && s === "Proformé");
        document
          .querySelectorAll(
            "#view-invoice input, #view-invoice textarea, #view-invoice select"
          )
          .forEach((e) => {
            if (
              currentUser.role === "validator" &&
              e.id === "inv-status" &&
              s === "Proformé"
            ) {
              e.disabled = false;
            } else if (
              currentUser.role === "validator" &&
              e.id === "inv-status" &&
              s !== "Proformé"
            ) {
              e.disabled = true;
            } else if (currentUser.role !== "validator") {
              e.disabled = isApprovedOrCancelled;
            } else {
              e.disabled = true;
            }
          });
        document
          .getElementById("inv-items-editor")
          .querySelectorAll("input, select, button")
          .forEach((e) => (e.disabled = isReadonly));
      }

      function upItem(i, f, v) {
        if (f === "desc") {
          const p = APP_DATA.prices.find((x) => x.desc === v);
          if (p) invItems[i].price = p.price;
          invItems[i].desc = v;
        } else {
          if (f === "qty" || f === "price") {
            invItems[i][f] = parseFloat(v) || 0;
          } else {
            invItems[i][f] = v;
          }
        }
        upInv();
      }

      function removeItem(i) {
        invItems.splice(i, 1);
        upInv();
      }

      function saveInvoice() {
        const inputs = {
          num: document.getElementById("inv-num").value,
          date: document.getElementById("inv-date").value,
          client: document.getElementById("inv-client").value,
          ref: document.getElementById("inv-ref").value,
          signClientName: document.getElementById("inv-sign-client-name").value,
          signClientFunc: document.getElementById("inv-sign-client-func").value,
          signItcName: document.getElementById("inv-sign-itc-name").value,
          signItcFunc: document.getElementById("inv-sign-itc-func").value,
        };

        const obj = {
          id:
            currentInvoiceIndex !== null
              ? APP_DATA.invoices[currentInvoiceIndex].id
              : Date.now(),
          ...inputs,
          status: document.getElementById("inv-status").value,
          total: parseFloat(
            document
              .getElementById("prev-total-ht")
              .innerText.replace(/\sFCFA/g, "")
              .replace(/\s/g, "")
              .replace(/,/g, ".") || 0
          ),
          items: invItems,
        };

        if (currentInvoiceIndex !== null)
          APP_DATA.invoices[currentInvoiceIndex] = obj;
        else APP_DATA.invoices.push(obj);
        localStorage.setItem(
          "itc_invoices_v1",
          JSON.stringify(APP_DATA.invoices)
        );
        alert("Proforma Sauvegardée");
        switchView("invoices-list");
      }

      function approveInvoice() {
        if (currentInvoiceIndex === null) {
          alert("Veuillez d'abord sauvegarder le Proforma.");
          return;
        }

        const currentStatus = document.getElementById("inv-status").value;
        if (currentStatus !== "Proformé") {
          alert("Seuls les Proformas 'Proformé' peuvent être validés.");
          return;
        }

        if (
          confirm(
            "Confirmez-vous la validation de ce Proforma ? Il sera marqué 'Validé' et la transmission par email sera simulée."
          )
        ) {
          document.getElementById("inv-status").value = "Validé";
          upInv();
          saveInvoice();
          alert(
            "✅ PROFORMA VALIDÉ !\n\nTransmission automatique par email simulée : Le client a reçu le Proforma N° " +
              document.getElementById("inv-num").value +
              " en PDF."
          );
        }
      }

      // --- GESTION DYNAMIQUE DES IMAGES (V45.24) ---

      function renderPhotoEditor(p, id, label) {
        const d = document.createElement("div");
        d.className = "bg-slate-50 p-2 rounded border mb-2";
        d.innerHTML = `
                      <label class="block text-[10px] font-bold text-pink-600 mb-1">${label}</label>
                      <div id="img-slots-${id}" class="space-y-2 mb-2"></div>
                      <input id="inp_comment_${id}" class="form-input text-xs h-6 mb-2" placeholder="Commentaire de la section photo..." oninput="renderPreview();">
                      <button type="button" onclick="addDynamicImageInput('${id}')" class="w-full bg-pink-100 text-pink-700 text-xs font-bold py-1 rounded hover:bg-pink-200 transition"><i class="fas fa-camera mr-1"></i> Ajouter une image</button>
                  `;
        p.appendChild(d);

        if (!imagesData[id] || !Array.isArray(imagesData[id].urls)) {
          const oldUrls =
            imagesData[id] && Array.isArray(imagesData[id])
              ? imagesData[id].filter((url) => url)
              : [];
          imagesData[id] = {
            urls: oldUrls,
            comment: document.getElementById(`inp_comment_${id}`)?.value || "",
          };
        }

        document.getElementById(`inp_comment_${id}`).value =
          imagesData[id].comment;

        imagesData[id].urls.forEach((url, index) =>
          addDynamicImageInput(id, url, index)
        );
        if (currentReportIndex === null && imagesData[id].urls.length === 0) {
          addDynamicImageInput(id);
        }
      }

      function addDynamicImageInput(id, initialUrl = null, initialIndex = -1) {
        const container = document.getElementById(`img-slots-${id}`);
        if (!container) return;

        const index =
          initialIndex !== -1 ? initialIndex : imagesData[id].urls.length;

        if (initialIndex === -1) {
          imagesData[id].urls.push(initialUrl);
        }

        const div = document.createElement("div");
        div.id = `img-slot-${id}-${index}`;
        div.className = "flex items-center gap-2 p-1 bg-white border rounded";

        const isImagePresent = !!imagesData[id].urls[index];

        const fileInputHtml = isImagePresent
          ? `<span class="text-xs text-green-600 truncate flex-1"><i class="fas fa-check-circle mr-1"></i> Fichier #${
              index + 1
            } chargé</span>`
          : `<input type="file" id="inp_${id}_${index}" class="text-[10px] flex-1" onchange="handleDynamicImageUpload('${id}', ${index}, this)">`;

        div.innerHTML = `
                      <span class="text-xs font-bold w-6 text-center text-slate-500">${
                        index + 1
                      }.</span>
                      ${fileInputHtml}
                      <button type="button" onclick="removeDynamicImageInput('${id}', ${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                  `;
        container.appendChild(div);

        if (isImagePresent && initialIndex === -1) renderPreview();
      }

      function removeDynamicImageInput(id, indexToRemove) {
        if (confirm("Supprimer cette image?")) {
          imagesData[id].urls.splice(indexToRemove, 1);
          imagesData[id].urls = imagesData[id].urls.filter((url) => url); // Clean nulls

          // Re-render la section complète pour réajuster les index et les inputs
          const parentElement = document.getElementById(`img-slots-${id}`)
            .parentNode.parentNode;
          renderPhotoEditor(
            parentElement,
            id,
            parentElement.querySelector("label").innerText.split("(")[0].trim()
          );

          renderPreview();
        }
      }

      function handleDynamicImageUpload(id, index, inputElement) {
        const file = inputElement.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagesData[id].urls[index] = e.target.result;
            renderPhotoSectionEditor(id);
            renderPreview();
          };
          reader.readAsDataURL(file);
        }
      }

      function renderPhotoSectionEditor(id) {
        const container = document.getElementById(`img-slots-${id}`);
        if (!container) return;
        container.innerHTML = "";

        imagesData[id].urls.forEach((url, index) =>
          addDynamicImageInput(id, url, index)
        );
      }

      function getPhotoHtml(id, t) {
        const data = imagesData[id] || { urls: [], comment: "" };
        const urls = data.urls.filter((url) => url);
        const c =
          document.getElementById(`inp_comment_${id}`)?.value ||
          data.comment ||
          "";

        if (urls.length === 0) return "";

        let gridClass = urls.length >= 3 ? "photo-grid-3" : "photo-grid";

        const imagesHtml = urls
          .map(
            (url) =>
              `<div class="photo-container-small"><img src="${url}"></div>`
          )
          .join("");

        return `
                      <div class="mb-3 break-inside-avoid">
                          <div class="font-bold text-slate-500 text-xs mb-1 ml-1">${t} (${
          urls.length
        } images)</div>
                          <div class="${gridClass}">
                              ${imagesHtml}
                          </div>
                          ${c ? `<div class="section-comment">${c}</div>` : ""}
                      </div>`;
      }

      function getRawPhotoHtml(id, t) {
        const data = imagesData[id] || { urls: [], comment: "" };
        const urls = data.urls.filter((url) => url);

        if (urls.length === 0) return "";

        // Utilise grid-template-columns: 1fr 1fr pour les deux sections A et B
        const imagesHtml = urls
          .map(
            (url) =>
              `<div class="photo-container">${
                url ? `<img src="${url}">` : ""
              }</div>`
          )
          .join("");

        return `
                      <div class="mb-3 break-inside-avoid">
                          <div class="font-bold text-slate-500 text-xs mb-1 ml-1">${t}</div>
                          ${imagesHtml}
                      </div>`;
      }

      // --- FIN GESTION DYNAMIQUE DES IMAGES ---

      function renderMapView() {
        const list = document.getElementById("map-sidebar-list");
        list.innerHTML = "";
        if (!mapInstance) {
          mapInstance = L.map("interactive-map").setView(
            [5.345317, -4.024429],
            12
          );
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "© OpenStreetMap",
          }).addTo(mapInstance);
          markersGroup = L.layerGroup().addTo(mapInstance);
        }
        setTimeout(() => {
          mapInstance.invalidateSize();
        }, 100);
        markersGroup.clearLayers();
        const mapReports = APP_DATA.reports.filter(
          (r) =>
            r.data.inputs.inp_pk_gps && r.data.inputs.inp_pk_gps.trim() !== ""
        );
        if (mapReports.length === 0) {
          list.innerHTML =
            '<div class="text-slate-400 italic text-center text-xs p-4">Aucun point GPS trouvé.</div>';
          return;
        }
        const bounds = [];
        mapReports.forEach((r, idx) => {
          const gps = r.data.inputs.inp_pk_gps;
          const match = gps.match(/(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/);
          if (match) {
            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);
            const marker = L.marker([lat, lng])
              .bindPopup(
                `<b>${r.summary.liaison}</b><br>${r.summary.date}<br>${
                  r.data.inputs.inp_cause || "Info"
                }<br><button onclick="loadReport(${APP_DATA.reports.indexOf(
                  r
                )})" class="text-blue-600 underline font-bold mt-1">Ouvrir</button>`
              )
              .addTo(markersGroup);
            bounds.push([lat, lng]);
            const item = document.createElement("div");
            item.className =
              "bg-white p-3 rounded border border-slate-200 hover:border-blue-500 hover:bg-slate-50 cursor-pointer transition";
            item.innerHTML = `<div class="font-bold text-slate-700 text-xs truncate">${
              r.summary.liaison
            }</div><div class="text-[10px] text-slate-500 mt-1 flex justify-between"><span>${
              r.summary.date
            }</span><span class="text-blue-500 font-mono">${lat.toFixed(
              4
            )}, ${lng.toFixed(4)}</span></div>`;
            item.onclick = () => {
              mapInstance.setView([lat, lng], 15);
              marker.openPopup();
            };
            list.appendChild(item);
          }
        });
        if (bounds.length > 0) {
          mapInstance.fitBounds(bounds, { padding: [50, 50] });
        }
      }

      function renderInvoicesTable() {
        document.getElementById("full-invoices-body").innerHTML =
          APP_DATA.invoices
            .slice()
            .reverse()
            .map((i, idx) => {
              let statusClass = "bg-slate-100 text-slate-700";
              if (i.status === "Validé")
                statusClass = "bg-green-100 text-green-700";
              else if (i.status === "Proformé")
                statusClass = "bg-orange-100 text-orange-700";
              else if (i.status === "Annulé")
                statusClass = "bg-red-100 text-red-700";

              return `<tr>
                          <td class="p-4">${i.date}</td>
                          <td class="p-4 font-bold">${i.num}</td>
                          <td class="p-4 text-xs">${
                            i.client.split("\n")[0]
                          }</td>
                          <td class="p-4 font-bold">${(
                            i.total || 0
                          ).toLocaleString()} FCFA</td>
                          <td class="p-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${statusClass}">${
                i.status
              }</span></td>
                          <td class="p-4 text-right"><button onclick="loadInvoice(${APP_DATA.invoices.indexOf(
                            i
                          )})" class="text-blue-600">Ouvrir</button></td>
                      </tr>`;
            })
            .join("");
      }

      // Fonction pour sauvegarder l'état actuel du formulaire en brouillon
      function saveDraft() {
        const draft = {
          type: document.getElementById("report-type").value,
          inputs: {},
          boq: boqData,
          surv: survData,
          fiber: fiberData,
          images: imagesData,
        };

        document.querySelectorAll('[id^="inp_"]').forEach((e) => {
          draft.inputs[e.id] = e.value;
        });

        localStorage.setItem("itc_report_draft", JSON.stringify(draft));
      }

      // Fonction pour charger le brouillon au démarrage
      function loadDraft() {
        const saved = localStorage.getItem("itc_report_draft");
        if (saved && currentReportIndex === null) {
          // Seulement si c'est un NOUVEAU rapport
          const draft = JSON.parse(saved);
          if (
            confirm(
              "Vous avez un rapport en cours non sauvegardé. Voulez-vous le restaurer ?"
            )
          ) {
            document.getElementById("report-type").value = draft.type;
            boqData = draft.boq;
            survData = draft.surv;
            fiberData = draft.fiber;
            imagesData = draft.images;

            renderForm(); // Reconstruit le HTML dynamique

            for (const [k, v] of Object.entries(draft.inputs)) {
              if (document.getElementById(k))
                document.getElementById(k).value = v;
            }
            renderPreview();
          } else {
            localStorage.removeItem("itc_report_draft");
          }
        }
      }

      // Modifier la fonction de sauvegarde finale pour vider le brouillon
      const originalSaveReport = saveReport;
      saveReport = function () {
        originalSaveReport();
        localStorage.removeItem("itc_report_draft"); // On vide le brouillon après succès
      };

      function loadReport(idx) {
        const r = APP_DATA.reports[idx];
        currentReportIndex = idx;

        // On définit le type
        document.getElementById("report-type").value = r.summary.type;

        // Reset des données globales
        boqData = JSON.parse(JSON.stringify(r.data.boq || []));
        survData = JSON.parse(JSON.stringify(r.data.surv || []));
        fiberData = JSON.parse(JSON.stringify(r.data.fiber || []));
        imagesData = JSON.parse(JSON.stringify(r.data.images || {}));

        // Reconstruction du formulaire
        renderForm();

        // Injection du code du rapport existant dans le formulaire (CRUCIAL)
        const formFields = document.getElementById("dynamic-form-fields");
        // On vérifie si l'input de code existe, sinon on le crée
        if (!document.getElementById("inp_report_code")) {
          const hiddenCode = document.createElement("input");
          hiddenCode.type = "hidden";
          hiddenCode.id = "inp_report_code";
          formFields.appendChild(hiddenCode);
        }
        document.getElementById("inp_report_code").value =
          r.data.inputs.inp_report_code || "N/A";

        // Injection des autres valeurs
        setTimeout(() => {
          for (const [k, v] of Object.entries(r.data.inputs)) {
            const el = document.getElementById(k);
            if (el) el.value = v;
          }
          renderPreview();
        }, 200);

        switchView("editor");
      }

      function addInp(p, i, l, t, d = "", o = []) {
        const div = document.createElement("div");
        div.innerHTML =
          `<label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">${l}</label>` +
          (t === "select"
            ? `<select id="inp_${i}" class="form-input" onchange="renderPreview()">${o
                .map(
                  (x) => `<option ${x === d ? "selected" : ""}>${x}</option>`
                )
                .join("")}</select>`
            : t === "textarea"
            ? `<textarea id="inp_${i}" class="form-input h-16" oninput="renderPreview()">${d}</textarea>`
            : `<input type="${t}" id="inp_${i}" class="form-input" value="${d}" oninput="renderPreview()">`);
        p.appendChild(div);
      }
      function addSection(p, t) {
        const d = document.createElement("div");
        d.className = "form-section-title";
        d.innerText = t;
        p.appendChild(d);
      }

      function renderBoqEditor() {
        const c = document.getElementById("boq-editor");
        c.innerHTML = boqData
          .map(
            (r, i) =>
              `<div class="flex gap-1"><input class="form-input w-2/3 mb-0" placeholder="Item" value="${r.item}" oninput="boqData[${i}].item=this.value;renderPreview()"><input class="form-input w-1/3 mb-0 text-center" placeholder="Qté" value="${r.qty}" oninput="boqData[${i}].qty=this.value;renderPreview()"></div>`
          )
          .join("");
      }
      function addBoqLine() {
        boqData.push({ item: "", qty: "" });
        renderBoqEditor();
        renderPreview();
      }
      function getBoqTableHtml() {
        return `<div class="section-header">MATÉRIEL</div><table class="boq-table"><thead><tr><th>Désignation</th><th class="w-16 text-center">Qté</th></tr></thead><tbody>${boqData
          .map(
            (b) =>
              `<tr><td>${b.item}</td><td class="text-center font-bold">${b.qty}</td></tr>`
          )
          .join("")}</tbody></table>`;
      }

      function renderFiberEditor() {
        const c = document.getElementById("fiber-editor");
        c.innerHTML = fiberData
          .map(
            (f, i) => `
                      <div class="flex gap-1 mb-1 items-start bg-slate-50 p-2 rounded border border-slate-200">
                          <input type="number" class="form-input w-12 text-center pt-2 font-bold text-xs bg-white rounded border border-slate-300 mr-1 shadow-sm h-8"
                                     value="${f.brin}"
                                     oninput="fiberData[${i}].brin=this.value;renderPreview()" placeholder="Port">
                          <div class="flex-1 space-y-1">
                              <div class="flex gap-1">
                                  <input class="form-input mb-0 text-center text-xs h-8" placeholder="A->B" value="${
                                    f.lossAB
                                  }" oninput="fiberData[${i}].lossAB=this.value;renderPreview()">
                                  <input class="form-input mb-0 text-center text-xs h-8" placeholder="B->A" value="${
                                    f.lossBA
                                  }" oninput="fiberData[${i}].lossBA=this.value;renderPreview()">
                                  <select class="form-input mb-0 text-xs h-8 font-bold ${
                                    f.status === "HS"
                                      ? "text-red-600"
                                      : f.status === "Occupé"
                                      ? "text-gray-400"
                                      : ""
                                  }" onchange="fiberData[${i}].status=this.value;renderFiberEditor();renderPreview()">
                                      <option value="OK" ${
                                        f.status === "OK" ? "selected" : ""
                                      }>OK</option>
                                      <option value="NOK" ${
                                        f.status === "NOK" ? "selected" : ""
                                      }>NOK</option>
                                      <option value="Occupé" ${
                                        f.status === "Occupé" ? "selected" : ""
                                      }>Occupé</option>
                                      <option value="HS" ${
                                        f.status === "HS" ? "selected" : ""
                                      }>HS</option>
                                  </select>
                              </div>
                              <input class="form-input mb-0 text-xs h-7 italic" placeholder="Commentaire..." value="${
                                f.comment
                              }" oninput="fiberData[${i}].comment=this.value;renderPreview()">
                          </div>
                          <button onclick="removeFiberLine(${i})" class="text-red-400 hover:text-red-600 ml-1 mt-2"><i class="fas fa-trash"></i></button>
                      </div>
                  `
          )
          .join("");
      }
      function addFiberLine() {
        fiberData.push({
          brin: fiberData.length + 1,
          lossAB: "",
          lossBA: "",
          status: "OK",
          comment: "",
        });
        renderFiberEditor();
        renderPreview();
      }
      function removeFiberLine(i) {
        fiberData.splice(i, 1);
        fiberData.forEach((f, idx) => (f.brin = f.brin));
        renderFiberEditor();
        renderPreview();
      }
      function addSurveillancePhoto() {
        const i = document.createElement("input");
        i.type = "file";
        i.onchange = (e) => {
          const r = new FileReader();
          r.onload = (ev) => {
            surveillanceImages.push(ev.target.result);
            renderPreview();
          };
          r.readAsDataURL(e.target.files[0]);
        };
        i.click();
      }
      function renderSurvEditor() {
        const c = document.getElementById("surv-editor");
        c.innerHTML = survData
          .map(
            (s, i) =>
              `<div class="flex gap-1 mb-1"><input type="date" class="form-input w-1/4" value="${s.date}" onchange="survData[${i}].date=this.value;renderPreview()"><input class="form-input w-1/4" placeholder="Axe" value="${s.axe}" oninput="survData[${i}].axe=this.value;renderPreview()"><input type="time" class="form-input w-1/6" value="${s.heure}" onchange="survData[${i}].heure=this.value;renderPreview()"><input class="form-input w-1/3" placeholder="Obs" value="${s.obs}" oninput="survData[${i}].obs=this.value;renderPreview()"></div>`
          )
          .join("");
      }
      function addSurvLine() {
        survData.push({ date: "", axe: "", heure: "", obs: "" });
        renderSurvEditor();
        renderPreview();
      }

      function saveReport() {
        const inputs = {};

        document
          .querySelectorAll('[id^="inp_"]')
          .forEach((e) => (inputs[e.id] = e.value));

        for (const key in imagesData) {
          const commentInput = document.getElementById(`inp_comment_${key}`);
          if (commentInput && imagesData[key]) {
            imagesData[key].comment = commentInput.value;
          }
        }

        const obj = {
          id:
            currentReportIndex !== null
              ? APP_DATA.reports[currentReportIndex].id
              : Date.now(),
          summary: {
            type: document.getElementById("report-type").value,
            date: inputs.inp_date_rapport,
            liaison: inputs.inp_liaison,
            intervenant: inputs.inp_intervenant,
          },
          data: {
            inputs,
            boq: boqData,
            images: imagesData,
            surv: survData,
            survImages: surveillanceImages,
            fiber: fiberData,
          },
        };

        if (currentReportIndex !== null)
          APP_DATA.reports[currentReportIndex] = obj;
        else APP_DATA.reports.push(obj);
        localStorage.setItem(
          "itc_reports_v34",
          JSON.stringify(APP_DATA.reports)
        );
        alert("Sauvegardé avec succès !");
        switchView("incidents");
      }

      document.getElementById("price-list-options").innerHTML = APP_DATA.prices
        .map((p) => `<option value="${p.desc}">`)
        .join("");
      checkAuth();
      loadDraft();
    </script>
  </body>
</html>
